{
  "lote": 0,
  "status": "pending",
  "file_path": "src/lib/useProfileVisits.ts",
  "created_at": "2026-02-27T05:36:07.518Z",
  "file_content": "import { useState, useEffect, useCallback } from 'react';\nimport { supabase } from './supabase';\n\nexport interface ProfileVisit {\n  id: string;\n  visitor_id: string;\n  visited_id: string;\n  visited_at: string;\n  visitor_data?: { id: string; name: string; profile_photo: string | null };\n}\n\nexport function useProfileVisits(userId?: string) {\n  const [visits, setVisits] = useState<ProfileVisit[]>([]);\n  const [visitCount, setVisitCount] = useState(0);\n  const [isLoading, setIsLoading] = useState(true);\n\n  const load = useCallback(async () => {\n    try {\n      const { data: { user } } = await supabase.auth.getUser();\n      const targetId = userId || user?.id;\n      if (!targetId) { setIsLoading(false); return; }\n\n      // Buscar visitas dos ultimos 30 dias\n      const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString();\n      const { data, error } = await supabase\n        .from('profile_visits')\n        .select('*')\n        .eq('visited_id', targetId)\n        .gte('visited_at', thirtyDaysAgo)\n        .order('visited_at', { ascending: false })\n        .limit(50);\n\n      if (error) throw error;\n\n      // Enriquecer com dados do visitante\n      const visitorIds = [...new Set((data || []).map(v => v.visitor_id))];\n      let visitorsMap: Record<string, any> = {};\n      if (visitorIds.length > 0) {\n        const { data: visitors } = await supabase\n          .from('users').select('id, name, profile_photo').in('id', visitorIds);\n        (visitors || []).forEach(v => { visitorsMap[v.id] = v; });\n      }\n\n      const enriched = (data || []).map(v => ({\n        ...v,\n        visitor_data: visitorsMap[v.visitor_id] || { id: v.visitor_id, name: 'Alguem', profile_photo: null }\n      }));\n\n      setVisits(enriched);\n      setVisitCount(visitorIds.length); // Visitantes unicos\n    } catch (err) {\n      console.error('[useProfileVisits] Erro:', err);\n    } finally {\n      setIsLoading(false);\n    }\n  }, [userId]);\n\n  useEffect(() => { load(); }, [load]);\n\n  // Registrar visita ao perfil de outro usuario\n  const registerVisit = useCallback(async (visitedId: string) => {\n    try {\n      const { data: { user } } = await supabase.auth.getUser();\n      if (!user || user.id === visitedId) return; // Nao registra visita propria\n\n      await supabase.from('profile_visits').insert({\n        visitor_id: user.id,\n        visited_id: visitedId,\n      }).then(() => {}).catch(() => {}); // Silencioso â€” duplicata do dia e ignorada pela UNIQUE constraint\n    } catch {\n      // Silencioso\n    }\n  }, []);\n\n  return { visits, visitCount, isLoading, registerVisit, refresh: load };\n}\n"
}