{
  "lote": 0,
  "status": "pending",
  "file_path": "src/lib/roleEngine.ts",
  "created_at": "2026-02-27T05:36:02.005Z",
  "file_content": "import type { UserRole } from './supabase';\n\n/**\n * ROLE ENGINE V9 — Fase 1: Alicerce\n * \n * 8 roles:\n *   visitor, registered_unfinished, member_free_legacy, member_paid,\n *   founder_paid, moderator, super_admin, banned\n * \n * Três camadas de acesso:\n *   1. has_app_access       → entrar no app (feed, postar, comentar)\n *   2. has_leadership_access → governar (criar comunidade, moderar, manifesto)\n *   3. is_waiting_approval   → cadastrado mas aguardando aprovação\n * \n * Roles legados (V7): member, founder, admin, user_free\n *   → normalizeRole() converte automaticamente para equivalentes V9\n */\n\n// Mapeamento de roles legados V7 → V9\nconst LEGACY_ROLE_MAP: Record<string, UserRole> = {\n  'member': 'member_free_legacy',\n  'founder': 'founder_paid',\n  'admin': 'super_admin',\n  'user_free': 'member_free_legacy',\n};\n\nconst VALID_ROLES: UserRole[] = [\n  'visitor',\n  'registered_unfinished',\n  'member_free_legacy',\n  'member_paid',\n  'founder_paid',\n  'moderator',\n  'super_admin',\n  'banned',\n];\n\n/** Normaliza o role vindo do banco (case-insensitive, sem espaços, migra legados) */\nexport function normalizeRole(raw: string | null | undefined): UserRole {\n  if (!raw) return 'visitor';\n  const cleaned = raw.trim().toLowerCase();\n\n  // Primeiro: checar se já é V9 válido\n  if (VALID_ROLES.includes(cleaned as UserRole)) return cleaned as UserRole;\n\n  // Segundo: tentar mapear de role legado V7\n  const mapped = LEGACY_ROLE_MAP[cleaned];\n  if (mapped) {\n    console.info(`[RoleEngine] Role legado \"${raw}\" → mapeado para \"${mapped}\"`);\n    return mapped;\n  }\n\n  // Fallback seguro — role desconhecido = sem acesso\n  console.warn(`[RoleEngine] Role desconhecido: \"${raw}\" → fallback para 'visitor'`);\n  return 'visitor';\n}\n\n/** \n * Acesso ao APP (Social Hub, Feed, Comunidades, postar, comentar)\n * registered_unfinished e banned NÃO têm acesso.\n */\nexport function hasAppAccess(role: UserRole | undefined | null): boolean {\n  const r = normalizeRole(role);\n  return r !== 'visitor' && r !== 'registered_unfinished' && r !== 'banned';\n}\n\n/** \n * Está aguardando aprovação? (signed up mas não aprovado)\n */\nexport function isWaitingApproval(role: UserRole | undefined | null): boolean {\n  return normalizeRole(role) === 'registered_unfinished';\n}\n\n/** \n * Está banido?\n */\nexport function isBanned(role: UserRole | undefined | null): boolean {\n  return normalizeRole(role) === 'banned';\n}\n\n/** \n * Acesso de LIDERANÇA (criar comunidade, moderar, editar manifesto, gerenciar membros)\n * Requer: role de liderança + onboarding de liderança concluído\n * super_admin tem acesso independente de onboarding\n */\nexport function hasLeadershipAccess(\n  role: UserRole | undefined | null,\n  leadershipOnboardingDone?: boolean\n): boolean {\n  const r = normalizeRole(role);\n  if (r === 'super_admin') return true;\n  if (r === 'founder_paid' || r === 'moderator') {\n    return leadershipOnboardingDone === true;\n  }\n  return false;\n}\n\n/** \n * Acesso de MODERAÇÃO (deletar posts de outros, gerenciar comunidades designadas)\n */\nexport function hasModAccess(role: UserRole | undefined | null): boolean {\n  const r = normalizeRole(role);\n  return r === 'founder_paid' || r === 'moderator' || r === 'super_admin';\n}\n\n/** Checar se é super_admin (Mila) */\nexport function isSuperAdmin(role: UserRole | undefined | null): boolean {\n  return normalizeRole(role) === 'super_admin';\n}\n\n/** Precisa de onboarding de liderança? */\nexport function needsLeadershipOnboarding(\n  role: UserRole | undefined | null,\n  leadershipOnboardingDone?: boolean\n): boolean {\n  const r = normalizeRole(role);\n  if (r === 'founder_paid' || r === 'moderator') {\n    return leadershipOnboardingDone !== true;\n  }\n  return false;\n}\n\n/** Página padrão para cada role */\nexport function getDefaultPage(role: UserRole | null | undefined): string {\n  const r = normalizeRole(role);\n  if (r === 'registered_unfinished') return 'waiting-room';\n  if (r === 'banned') return 'banned';\n  if (r === 'super_admin') return 'social-hub';\n  if (r === 'member_free_legacy' || r === 'member_paid') return 'social-hub';\n  if (r === 'founder_paid' || r === 'moderator') return 'social-hub';\n  return 'home';\n}\n\n/** Hierarquia de poder — usado para verificar quem pode promover/rebaixar quem */\nexport function getRolePower(role: UserRole | undefined | null): number {\n  const POWER: Record<UserRole, number> = {\n    'visitor': 0,\n    'banned': 0,\n    'registered_unfinished': 1,\n    'member_free_legacy': 10,\n    'member_paid': 20,\n    'founder_paid': 50,\n    'moderator': 60,\n    'super_admin': 100,\n  };\n  return POWER[normalizeRole(role)] ?? 0;\n}\n"
}