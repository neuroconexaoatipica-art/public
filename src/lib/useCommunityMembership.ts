{
  "lote": 0,
  "status": "pending",
  "file_path": "src/lib/useCommunityMembership.ts",
  "created_at": "2026-02-27T05:36:04.406Z",
  "file_content": "import { useState, useEffect, useCallback } from 'react';\nimport { supabase } from './supabase';\nimport { useProfileContext } from './ProfileContext';\nimport { isSuperAdmin } from './roleEngine';\n\n/**\n * useCommunityMembership — Hook para membership gate por comunidade\n * \n * Verifica se o usuário é membro de uma comunidade específica.\n * Se a comunidade tem requires_approval = true, o user precisa\n * ser membro aprovado para ver o conteúdo.\n * \n * Statuses de membership:\n * - 'approved' → membro ativo, pode ver e participar\n * - 'pending'  → pediu entrada, aguardando aprovação\n * - 'rejected' → pedido negado\n * - null       → nunca pediu entrada\n */\n\nexport type MembershipStatus = 'approved' | 'pending' | 'rejected' | null;\n\ninterface MembershipResult {\n  /** Status do membership do user nesta comunidade */\n  status: MembershipStatus;\n  /** Pode ver o conteúdo da comunidade? */\n  canView: boolean;\n  /** Pode postar/interagir na comunidade? */\n  canParticipate: boolean;\n  /** A comunidade requer aprovação? */\n  requiresApproval: boolean;\n  /** Carregando? */\n  isLoading: boolean;\n  /** Pedir entrada na comunidade */\n  requestEntry: (message?: string) => Promise<{ success: boolean; error?: string }>;\n  /** Recarregar status */\n  refresh: () => Promise<void>;\n}\n\nexport function useCommunityMembership(communityId: string | undefined): MembershipResult {\n  const { user } = useProfileContext();\n  const [status, setStatus] = useState<MembershipStatus>(null);\n  const [requiresApproval, setRequiresApproval] = useState(false);\n  const [isLoading, setIsLoading] = useState(true);\n\n  // super_admin sempre tem acesso total\n  const isAdmin = isSuperAdmin(user?.role);\n\n  const loadMembership = useCallback(async () => {\n    if (!communityId || !user?.id) {\n      setIsLoading(false);\n      return;\n    }\n\n    try {\n      // 1. Checar se a comunidade requer aprovação\n      const { data: community } = await supabase\n        .from('communities')\n        .select('requires_approval, owner_id')\n        .eq('id', communityId)\n        .single();\n\n      const reqApproval = community?.requires_approval ?? false;\n      setRequiresApproval(reqApproval);\n\n      // Se é o owner, sempre tem acesso\n      if (community?.owner_id === user.id) {\n        setStatus('approved');\n        setIsLoading(false);\n        return;\n      }\n\n      // Se não requer aprovação, todos os membros do app têm acesso\n      if (!reqApproval) {\n        setStatus('approved');\n        setIsLoading(false);\n        return;\n      }\n\n      // 2. Checar membership do user\n      const { data: membership } = await supabase\n        .from('community_members')\n        .select('status')\n        .eq('community_id', communityId)\n        .eq('user_id', user.id)\n        .single();\n\n      if (membership) {\n        setStatus(membership.status as MembershipStatus);\n      } else {\n        setStatus(null);\n      }\n    } catch (err) {\n      console.error('[Membership] Erro ao verificar:', err);\n      // Fallback: permitir acesso para não bloquear existentes\n      setStatus('approved');\n    } finally {\n      setIsLoading(false);\n    }\n  }, [communityId, user?.id]);\n\n  useEffect(() => {\n    loadMembership();\n  }, [loadMembership]);\n\n  const requestEntry = useCallback(async (message?: string) => {\n    if (!communityId || !user?.id) {\n      return { success: false, error: 'Usuário não logado' };\n    }\n\n    try {\n      const { error } = await supabase\n        .from('community_members')\n        .upsert(\n          {\n            community_id: communityId,\n            user_id: user.id,\n            status: 'pending',\n            request_message: message || null,\n          },\n          { onConflict: 'community_id,user_id' }\n        );\n\n      if (error) throw error;\n\n      setStatus('pending');\n      return { success: true };\n    } catch (err: any) {\n      console.error('[Membership] Erro ao pedir entrada:', err);\n      return { success: false, error: err.message || 'Erro ao enviar pedido' };\n    }\n  }, [communityId, user?.id]);\n\n  // Permissões derivadas\n  const canView = isAdmin || status === 'approved' || !requiresApproval;\n  const canParticipate = isAdmin || status === 'approved' || !requiresApproval;\n\n  return {\n    status: isAdmin ? 'approved' : status,\n    canView,\n    canParticipate,\n    requiresApproval,\n    isLoading,\n    requestEntry,\n    refresh: loadMembership,\n  };\n}\n"
}