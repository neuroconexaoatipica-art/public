{
  "lote": 0,
  "status": "pending",
  "file_path": "src/lib/useTestimonials.ts",
  "created_at": "2026-02-27T05:36:08.981Z",
  "file_content": "import { useState, useEffect, useCallback } from 'react';\nimport { supabase } from './supabase';\n\nexport interface Testimonial {\n  id: string;\n  author_id: string;\n  target_user_id: string;\n  content: string;\n  is_approved: boolean;\n  is_visible: boolean;\n  created_at: string;\n  author_data?: { id: string; name: string; profile_photo: string | null; role: string };\n}\n\nexport function useTestimonials(targetUserId: string | null) {\n  const [testimonials, setTestimonials] = useState<Testimonial[]>([]);\n  const [isLoading, setIsLoading] = useState(true);\n\n  const load = useCallback(async () => {\n    if (!targetUserId) { setIsLoading(false); return; }\n    try {\n      const { data, error } = await supabase\n        .from('testimonials')\n        .select('*')\n        .eq('target_user_id', targetUserId)\n        .eq('is_visible', true)\n        .eq('is_approved', true)\n        .order('created_at', { ascending: false });\n\n      if (error) throw error;\n\n      const authorIds = [...new Set((data || []).map(t => t.author_id))];\n      let authorsMap: Record<string, any> = {};\n      if (authorIds.length > 0) {\n        const { data: authors } = await supabase\n          .from('users').select('id, name, profile_photo, role').in('id', authorIds);\n        (authors || []).forEach(a => { authorsMap[a.id] = a; });\n      }\n\n      setTestimonials((data || []).map(t => ({\n        ...t,\n        author_data: authorsMap[t.author_id] || { id: t.author_id, name: 'Membro', profile_photo: null, role: 'member' }\n      })));\n    } catch (err) {\n      console.error('[useTestimonials] Erro:', err);\n    } finally {\n      setIsLoading(false);\n    }\n  }, [targetUserId]);\n\n  useEffect(() => { load(); }, [load]);\n\n  const writeTestimonial = useCallback(async (targetId: string, content: string) => {\n    try {\n      const { data: { user } } = await supabase.auth.getUser();\n      if (!user) return { success: false, error: 'Nao autenticado' };\n      if (user.id === targetId) return { success: false, error: 'Nao pode escrever reconhecimento para si mesmo' };\n\n      const { error } = await supabase.from('testimonials').upsert({\n        author_id: user.id,\n        target_user_id: targetId,\n        content: content.trim(),\n      }, { onConflict: 'author_id,target_user_id' });\n\n      if (error) throw error;\n      await load();\n      return { success: true };\n    } catch (err: any) {\n      return { success: false, error: err.message };\n    }\n  }, [load]);\n\n  return { testimonials, isLoading, writeTestimonial, refresh: load };\n}\n"
}