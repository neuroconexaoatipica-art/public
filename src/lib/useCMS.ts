{
  "lote": 0,
  "status": "pending",
  "file_path": "src/lib/useCMS.ts",
  "created_at": "2026-02-27T05:36:03.337Z",
  "file_content": "import { useState, useEffect, useCallback } from 'react';\nimport { supabase } from './supabase';\n\n// ═══════════════════════════════════════════════════════════════\n// HOOKS CMS — Fase 1 V8\n// Consumir platform_copy, home_sections, legal_pages, announcements\n// ═══════════════════════════════════════════════════════════════\n\n// ─── platform_copy ────────────────────────────────────────────\nexport interface PlatformCopy {\n  id: string;\n  copy_key: string;\n  copy_value: string;\n  context: 'landing' | 'app' | 'both' | 'admin';\n  updated_at: string;\n}\n\n/** Carrega todos os textos de um contexto (ou todos) */\nexport function usePlatformCopy(context?: 'landing' | 'app' | 'both' | 'admin') {\n  const [copies, setCopies] = useState<Record<string, string>>({});\n  const [isLoading, setIsLoading] = useState(true);\n\n  useEffect(() => {\n    let cancelled = false;\n\n    async function load() {\n      try {\n        let query = supabase.from('platform_copy').select('copy_key, copy_value, context');\n        \n        if (context) {\n          // Buscar o contexto especificado + 'both' (universal)\n          query = query.in('context', context === 'both' ? ['both'] : [context, 'both']);\n        }\n\n        const { data, error } = await query;\n        if (error) throw error;\n        if (cancelled) return;\n\n        const map: Record<string, string> = {};\n        data?.forEach((row: { copy_key: string; copy_value: string }) => {\n          map[row.copy_key] = row.copy_value;\n        });\n        setCopies(map);\n      } catch (err) {\n        console.error('[usePlatformCopy] Erro:', err);\n      } finally {\n        if (!cancelled) setIsLoading(false);\n      }\n    }\n\n    load();\n    return () => { cancelled = true; };\n  }, [context]);\n\n  /** Helper: pega um texto pelo key, com fallback */\n  const getText = useCallback(\n    (key: string, fallback = '') => copies[key] ?? fallback,\n    [copies]\n  );\n\n  return { copies, getText, isLoading };\n}\n\n// ─── home_sections ────────────────────────────────────────────\nexport interface HomeSection {\n  id: string;\n  section_key: string;\n  title: string;\n  subtitle: string | null;\n  display_order: number;\n  section_type: string;\n  is_active: boolean;\n  metadata: Record<string, unknown>;\n}\n\n/** Carrega seções ativas da home, ordenadas */\nexport function useHomeSections() {\n  const [sections, setSections] = useState<HomeSection[]>([]);\n  const [isLoading, setIsLoading] = useState(true);\n\n  useEffect(() => {\n    let cancelled = false;\n\n    async function load() {\n      try {\n        const { data, error } = await supabase\n          .from('home_sections')\n          .select('*')\n          .eq('is_active', true)\n          .order('display_order', { ascending: true });\n\n        if (error) throw error;\n        if (!cancelled) setSections(data ?? []);\n      } catch (err) {\n        console.error('[useHomeSections] Erro:', err);\n      } finally {\n        if (!cancelled) setIsLoading(false);\n      }\n    }\n\n    load();\n    return () => { cancelled = true; };\n  }, []);\n\n  return { sections, isLoading };\n}\n\n// ─── legal_pages ──────────────────────────────────────────────\nexport type LegalPageKey = \n  | 'ethics'\n  | 'privacy_policy'\n  | 'terms_of_use'\n  | 'moderation_policy'\n  | 'security_policy'\n  | 'child_protection_policy';\n\nexport interface LegalPage {\n  id: string;\n  page_key: LegalPageKey;\n  title: string;\n  content_html: string;\n  version: string;\n  is_active: boolean;\n  updated_at: string;\n}\n\n/** Carrega uma página jurídica específica */\nexport function useLegalPage(pageKey: LegalPageKey) {\n  const [page, setPage] = useState<LegalPage | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n\n  useEffect(() => {\n    let cancelled = false;\n\n    async function load() {\n      try {\n        const { data, error: err } = await supabase\n          .from('legal_pages')\n          .select('*')\n          .eq('page_key', pageKey)\n          .eq('is_active', true)\n          .single();\n\n        if (err) throw err;\n        if (!cancelled) setPage(data);\n      } catch (err: unknown) {\n        console.error(`[useLegalPage] Erro ao carregar ${pageKey}:`, err);\n        if (!cancelled) setError(err instanceof Error ? err.message : 'Erro ao carregar página');\n      } finally {\n        if (!cancelled) setIsLoading(false);\n      }\n    }\n\n    load();\n    return () => { cancelled = true; };\n  }, [pageKey]);\n\n  return { page, isLoading, error };\n}\n\n/** Carrega todas as páginas jurídicas (para índice) */\nexport function useLegalPages() {\n  const [pages, setPages] = useState<LegalPage[]>([]);\n  const [isLoading, setIsLoading] = useState(true);\n\n  useEffect(() => {\n    let cancelled = false;\n\n    async function load() {\n      try {\n        const { data, error } = await supabase\n          .from('legal_pages')\n          .select('id, page_key, title, version, is_active, updated_at')\n          .eq('is_active', true)\n          .order('title');\n\n        if (error) throw error;\n        if (!cancelled) setPages((data ?? []) as LegalPage[]);\n      } catch (err) {\n        console.error('[useLegalPages] Erro:', err);\n      } finally {\n        if (!cancelled) setIsLoading(false);\n      }\n    }\n\n    load();\n    return () => { cancelled = true; };\n  }, []);\n\n  return { pages, isLoading };\n}\n\n// ─── home_announcements ──────────────────────────────────────\nexport interface Announcement {\n  id: string;\n  title: string;\n  content: string;\n  announcement_type: 'info' | 'warning' | 'celebration' | 'urgent';\n  is_active: boolean;\n  starts_at: string;\n  ends_at: string | null;\n  created_at: string;\n}\n\n/** Carrega comunicados ativos (dentro da janela de tempo) */\nexport function useAnnouncements() {\n  const [announcements, setAnnouncements] = useState<Announcement[]>([]);\n  const [isLoading, setIsLoading] = useState(true);\n\n  useEffect(() => {\n    let cancelled = false;\n\n    async function load() {\n      try {\n        const now = new Date().toISOString();\n        const { data, error } = await supabase\n          .from('home_announcements')\n          .select('*')\n          .eq('is_active', true)\n          .lte('starts_at', now)\n          .or(`ends_at.is.null,ends_at.gte.${now}`)\n          .order('starts_at', { ascending: false });\n\n        if (error) throw error;\n        if (!cancelled) setAnnouncements(data ?? []);\n      } catch (err) {\n        console.error('[useAnnouncements] Erro:', err);\n      } finally {\n        if (!cancelled) setIsLoading(false);\n      }\n    }\n\n    load();\n    return () => { cancelled = true; };\n  }, []);\n\n  return { announcements, isLoading };\n}\n"
}