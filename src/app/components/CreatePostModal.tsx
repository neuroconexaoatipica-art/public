{
  "lote": 4,
  "status": "pending",
  "file_path": "src/app/components/CreatePostModal.tsx",
  "created_at": "2026-02-27T05:36:21.346Z",
  "file_content": "import { supabase, useImageUpload, useCommunitiesContext, TIMEOUTS } from \"../../lib\";\nimport { cleanTextInput, validateImageFile, RATE_LIMITS, MAX_LENGTHS } from \"../../lib\";\nimport { motion, AnimatePresence } from \"motion/react\";\nimport { X, Loader2, Globe, Lock, Image, Trash2, CheckCircle } from \"lucide-react\";\nimport { useState, useRef, useEffect } from \"react\";\n\ninterface CreatePostModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  onPostCreated?: () => void;\n  defaultCommunityId?: string | null;\n}\n\n// Mensagens progressivas de loading — feedback visual pro usuário saber que está funcionando\nconst LOADING_STAGES = [\n  { delay: 0, text: \"Publicando...\" },\n  { delay: 4000, text: \"Conectando ao servidor...\" },\n  { delay: 10000, text: \"Servidor acordando (plano gratuito)... aguarde\" },\n  { delay: 20000, text: \"Quase lá... não feche a janela\" },\n  { delay: 35000, text: \"Última tentativa...\" },\n];\n\nexport function CreatePostModal({ isOpen, onClose, onPostCreated, defaultCommunityId }: CreatePostModalProps) {\n  const [content, setContent] = useState(\"\");\n  const [isPublic, setIsPublic] = useState(false);\n  const [selectedCommunity, setSelectedCommunity] = useState<string | null>(defaultCommunityId || null);\n  const [isLoading, setIsLoading] = useState(false);\n  const [loadingText, setLoadingText] = useState(\"Publicando...\");\n  const [error, setError] = useState(\"\");\n  const [debugInfo, setDebugInfo] = useState(\"\");\n  const [imageFile, setImageFile] = useState<File | null>(null);\n  const [imagePreview, setImagePreview] = useState<string | null>(null);\n  const [cooldown, setCooldown] = useState(0);\n  const [showSuccess, setShowSuccess] = useState(false);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const loadingTimersRef = useRef<ReturnType<typeof setTimeout>[]>([]);\n  const { uploadImage } = useImageUpload();\n  const { communities } = useCommunitiesContext();\n\n  const realCommunities = communities.filter(c => !c.id.startsWith('pending-') && !c.id.startsWith('local-'));\n\n  useEffect(() => {\n    if (isOpen) {\n      // RESET COMPLETO — garante estado limpo toda vez que o modal abre\n      setContent(\"\");\n      setIsPublic(false);\n      setSelectedCommunity(defaultCommunityId || null);\n      setIsLoading(false);\n      setLoadingText(\"Publicando...\");\n      setError(\"\");\n      setDebugInfo(\"\");\n      setImageFile(null);\n      setImagePreview(null);\n      setCooldown(0);\n      setShowSuccess(false);\n      // Limpar qualquer timer residual de loading progressivo\n      loadingTimersRef.current.forEach(clearTimeout);\n      loadingTimersRef.current = [];\n    }\n  }, [isOpen, defaultCommunityId]);\n\n  // Limpar timers ao desmontar\n  useEffect(() => {\n    return () => {\n      loadingTimersRef.current.forEach(clearTimeout);\n    };\n  }, []);\n\n  const startProgressiveLoading = () => {\n    // Limpar timers anteriores\n    loadingTimersRef.current.forEach(clearTimeout);\n    loadingTimersRef.current = [];\n\n    LOADING_STAGES.forEach(stage => {\n      const timer = setTimeout(() => setLoadingText(stage.text), stage.delay);\n      loadingTimersRef.current.push(timer);\n    });\n  };\n\n  const stopProgressiveLoading = () => {\n    loadingTimersRef.current.forEach(clearTimeout);\n    loadingTimersRef.current = [];\n  };\n\n  // Traduz código de erro do Supabase em mensagem que um humano entende\n  const translateError = (code: string, message: string, hint: string): string => {\n    switch (code) {\n      case '42501':\n        return 'Permissão negada. Seu perfil pode não ter acesso para postar nesta comunidade. Entre em contato com a administração.';\n      case '23503':\n        return 'A comunidade selecionada não existe no banco de dados. Tente selecionar outra comunidade.';\n      case '23502':\n        return `Campo obrigatório faltando no banco: ${hint || message}. Isso é um bug — entre em contato com a administração.`;\n      case '23505':\n        return 'Post duplicado detectado. Aguarde alguns segundos e tente novamente.';\n      case 'PGRST301':\n        return 'Sua sessão expirou. Faça logout e entre novamente.';\n      default:\n        if (message?.includes('JWT')) return 'Sessão expirada. Faça logout e entre novamente.';\n        if (message?.includes('timeout') || message?.includes('abort')) return 'O servidor demorou para responder. Isso acontece quando o servidor está \"dormindo\" (plano gratuito). Tente novamente — a segunda tentativa costuma ser instantânea.';\n        return message || 'Erro desconhecido. Tente novamente.';\n    }\n  };\n\n  const doSubmit = async (isRetry = false) => {\n    setError(\"\");\n    setDebugInfo(\"\");\n\n    // v1.1: Rate limit local anti-spam\n    const rateCheck = RATE_LIMITS.CREATE_POST();\n    if (!rateCheck.allowed) {\n      setError(`Voce esta postando rapido demais. Aguarde ${Math.ceil(rateCheck.retryAfterMs / 1000)}s.`);\n      return;\n    }\n\n    setIsLoading(true);\n    setShowSuccess(false);\n    startProgressiveLoading();\n\n    try {\n      // 1. Sessão (instantâneo — dados locais)\n      const { data: { session } } = await supabase.auth.getSession();\n      if (!session?.user) {\n        throw { userMessage: 'Você precisa estar logada. Faça logout e entre novamente.' };\n      }\n\n      const userId = session.user.id;\n\n      // 2. Upload de imagem (se houver)\n      let imageUrl: string | null = null;\n      if (imageFile) {\n        // v1.1: Validacao de imagem\n        const imgValidation = validateImageFile(imageFile);\n        if (!imgValidation.valid) {\n          throw { userMessage: imgValidation.message };\n        }\n        setLoadingText(\"Enviando imagem...\");\n        try {\n          const uploadResult = await uploadImage(imageFile, 'avatars', 'post-images');\n          if (!uploadResult.success || !uploadResult.url) {\n            throw { userMessage: `Falha no upload da imagem: ${uploadResult.error || 'tente novamente'}` };\n          }\n          imageUrl = uploadResult.url;\n        } catch (e: any) {\n          if (e.userMessage) throw e;\n          throw { userMessage: `Falha no upload: ${e.message}` };\n        }\n      }\n\n      // 3. Montar payload completo — todos os campos obrigatórios explícitos\n      const postPayload = {\n        content: cleanTextInput(content, MAX_LENGTHS.POST_CONTENT),\n        author: userId,\n        is_public: isPublic,\n        is_pinned: false,\n        community: selectedCommunity || null,\n        image_url: imageUrl,\n      };\n\n      console.log('[CreatePost] Enviando payload:', {\n        content_length: postPayload.content.length,\n        community: postPayload.community,\n        is_public: postPayload.is_public,\n        has_image: !!imageUrl,\n        is_retry: isRetry,\n      });\n\n      setLoadingText(isRetry ? \"Tentando novamente...\" : \"Publicando...\");\n\n      // 4. INSERT — direto pelo supabase-js (timeout global de 45s já configurado)\n      const { error: postError, data: postData } = await supabase\n        .from('posts')\n        .insert(postPayload)\n        .select()\n        .single();\n\n      if (postError) {\n        const code = (postError as any).code || '';\n        const hint = (postError as any).hint || '';\n        console.error('[CreatePost] Erro Supabase:', { code, message: postError.message, hint });\n        setDebugInfo(`Código: ${code} | ${postError.message} | ${hint} | community: ${postPayload.community}`);\n        throw { userMessage: translateError(code, postError.message, hint) };\n      }\n\n      // 5. SUCESSO\n      console.log('[CreatePost] Post criado:', postData?.id);\n      stopProgressiveLoading();\n      setIsLoading(false);\n      setShowSuccess(true);\n      setContent(\"\");\n      setIsPublic(false);\n      setSelectedCommunity(null);\n      setImageFile(null);\n      setImagePreview(null);\n\n      // Fechar modal após feedback visual\n      setTimeout(() => {\n        setShowSuccess(false);\n        onClose();\n        try { onPostCreated?.(); } catch {}\n      }, 1500);\n\n      // Cooldown anti-spam\n      setCooldown(30);\n      const timer = setInterval(() => {\n        setCooldown(prev => {\n          if (prev <= 1) { clearInterval(timer); return 0; }\n          return prev - 1;\n        });\n      }, 1000);\n\n    } catch (err: any) {\n      stopProgressiveLoading();\n      setIsLoading(false);\n\n      const message = err.userMessage || err.message || 'Erro desconhecido';\n\n      // Auto-retry UMA vez em caso de timeout (cold start)\n      if (!isRetry && (message.includes('abort') || message.includes('timeout') || message.includes('dormindo'))) {\n        console.log('[CreatePost] Timeout detectado, retry automático...');\n        setLoadingText(\"Servidor acordou! Tentando novamente...\");\n        setTimeout(() => doSubmit(true), 1000);\n        return;\n      }\n\n      setError(message);\n      console.error('[CreatePost] ERRO FINAL:', message);\n    }\n  };\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    if (content.trim().length === 0 && !imageFile) {\n      setError(\"Escreva algo ou adicione uma imagem antes de publicar\");\n      return;\n    }\n    if (content.length > 5000) {\n      setError(\"Post muito longo. Máximo 5000 caracteres\");\n      return;\n    }\n    await doSubmit();\n  };\n\n  const handleImageChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (file) {\n      setImageFile(file);\n      const reader = new FileReader();\n      reader.onloadend = () => { setImagePreview(reader.result as string); };\n      reader.readAsDataURL(file);\n    }\n  };\n\n  const handleRemoveImage = () => {\n    setImageFile(null);\n    setImagePreview(null);\n  };\n\n  return (\n    <AnimatePresence>\n      {isOpen && (\n        <motion.div\n          initial={{ opacity: 0 }}\n          animate={{ opacity: 1 }}\n          exit={{ opacity: 0 }}\n          transition={{ duration: 0.2 }}\n          className=\"fixed inset-0 z-50 flex items-center justify-center bg-[#35363A]/90 backdrop-blur-sm px-4\"\n          onClick={onClose}\n        >\n          <motion.div\n            initial={{ opacity: 0, scale: 0.95, y: 20 }}\n            animate={{ opacity: 1, scale: 1, y: 0 }}\n            exit={{ opacity: 0, scale: 0.95, y: 20 }}\n            transition={{ duration: 0.3, ease: \"easeOut\" }}\n            onClick={(e) => e.stopPropagation()}\n            className=\"relative w-full max-w-2xl bg-[#35363A] rounded-2xl shadow-2xl p-8 border border-white/10 max-h-[90vh] overflow-y-auto\"\n          >\n            <button\n              onClick={onClose}\n              className=\"absolute top-4 right-4 p-2 hover:bg-white/5 rounded-lg transition-colors\"\n            >\n              <X className=\"h-5 w-5 text-white/60\" />\n            </button>\n\n            <h2 className=\"text-2xl font-semibold mb-6 text-white\">Criar Post</h2>\n\n            <form onSubmit={handleSubmit} className=\"space-y-6\">\n              {realCommunities.length > 0 && (\n                <div>\n                  <label className=\"block text-sm font-medium text-white/90 mb-2\">\n                    Comunidade (opcional)\n                  </label>\n                  <select\n                    value={selectedCommunity || ''}\n                    onChange={(e) => setSelectedCommunity(e.target.value || null)}\n                    disabled={isLoading}\n                    className=\"w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#81D8D0] focus:border-transparent transition-all text-white disabled:opacity-50 appearance-none cursor-pointer\"\n                  >\n                    <option value=\"\" className=\"bg-[#35363A]\">Feed Geral</option>\n                    {realCommunities.map(c => (\n                      <option key={c.id} value={c.id} className=\"bg-[#35363A]\">\n                        {c.name}\n                      </option>\n                    ))}\n                  </select>\n                </div>\n              )}\n\n              <div>\n                <textarea\n                  value={content}\n                  onChange={(e) => setContent(e.target.value)}\n                  placeholder=\"O que você está pensando?\"\n                  rows={6}\n                  disabled={isLoading}\n                  className=\"w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#81D8D0] focus:border-transparent transition-all text-white placeholder:text-white/40 disabled:opacity-50 resize-none text-base\"\n                />\n                <div className=\"flex items-center justify-between mt-2\">\n                  <p className=\"text-xs text-white/50\">{content.length}/5000 caracteres</p>\n                  {content.length > 4500 && (\n                    <p className=\"text-xs text-[#FF6B35]\">Chegando ao limite</p>\n                  )}\n                </div>\n              </div>\n\n              <div className=\"relative\">\n                {imagePreview ? (\n                  <div className=\"relative\">\n                    <img src={imagePreview} alt=\"Preview\" className=\"w-full h-64 object-cover rounded-xl\" />\n                    <button\n                      type=\"button\"\n                      onClick={handleRemoveImage}\n                      disabled={isLoading}\n                      className=\"absolute top-2 right-2 p-2 bg-black/60 backdrop-blur-sm rounded-full text-white hover:bg-black/80 transition-colors disabled:opacity-50\"\n                    >\n                      <Trash2 className=\"h-4 w-4\" />\n                    </button>\n                  </div>\n                ) : (\n                  <button\n                    type=\"button\"\n                    onClick={() => fileInputRef.current?.click()}\n                    disabled={isLoading}\n                    className=\"w-full py-8 bg-white/5 border-2 border-dashed border-white/10 rounded-xl flex flex-col items-center justify-center text-white/60 hover:text-white/90 hover:border-[#81D8D0]/40 hover:bg-white/8 transition-all disabled:opacity-50\"\n                  >\n                    <Image className=\"h-8 w-8 mb-2\" />\n                    <p className=\"text-sm font-medium\">Adicionar Imagem (opcional)</p>\n                    <p className=\"text-xs text-white/40 mt-1\">Máximo 5MB - JPG, PNG, WebP ou GIF</p>\n                  </button>\n                )}\n                <input\n                  type=\"file\"\n                  accept=\"image/jpeg,image/jpg,image/png,image/webp,image/gif\"\n                  ref={fileInputRef}\n                  onChange={handleImageChange}\n                  disabled={isLoading}\n                  className=\"hidden\"\n                />\n              </div>\n\n              <div className=\"space-y-3\">\n                <label className=\"block text-sm font-medium text-white/90\">Visibilidade</label>\n                <div className=\"flex gap-3\">\n                  <button\n                    type=\"button\"\n                    onClick={() => setIsPublic(false)}\n                    className={`flex-1 flex items-center gap-3 p-4 rounded-xl border-2 transition-all ${\n                      !isPublic\n                        ? 'bg-[#81D8D0]/10 border-[#81D8D0] text-white'\n                        : 'bg-white/3 border-white/10 text-white/70 hover:bg-white/5'\n                    }`}\n                  >\n                    <Lock className=\"h-5 w-5 flex-shrink-0\" />\n                    <div className=\"text-left\">\n                      <p className=\"font-semibold text-sm\">Apenas Membros</p>\n                      <p className=\"text-xs opacity-80\">Somente quem tem acesso</p>\n                    </div>\n                  </button>\n                  <button\n                    type=\"button\"\n                    onClick={() => setIsPublic(true)}\n                    className={`flex-1 flex items-center gap-3 p-4 rounded-xl border-2 transition-all ${\n                      isPublic\n                        ? 'bg-[#81D8D0]/10 border-[#81D8D0] text-white'\n                        : 'bg-white/3 border-white/10 text-white/70 hover:bg-white/5'\n                    }`}\n                  >\n                    <Globe className=\"h-5 w-5 flex-shrink-0\" />\n                    <div className=\"text-left\">\n                      <p className=\"font-semibold text-sm\">Público</p>\n                      <p className=\"text-xs opacity-80\">Qualquer visitante pode ver</p>\n                    </div>\n                  </button>\n                </div>\n              </div>\n\n              {/* Erro + debug info */}\n              {error && (\n                <div className=\"p-4 bg-[#C8102E]/10 border border-[#C8102E]/30 rounded-xl space-y-2\">\n                  <p className=\"text-sm text-[#C8102E]\">{error}</p>\n                  {debugInfo && (\n                    <details className=\"text-xs text-[#C8102E]/60\">\n                      <summary className=\"cursor-pointer hover:text-[#C8102E]/80\">Detalhes técnicos (para suporte)</summary>\n                      <p className=\"font-mono break-all mt-1 p-2 bg-black/20 rounded\">{debugInfo}</p>\n                    </details>\n                  )}\n                  <button\n                    type=\"button\"\n                    onClick={() => doSubmit()}\n                    className=\"w-full mt-2 py-2.5 bg-[#FF6B35] text-white rounded-xl hover:bg-[#FF6B35]/90 transition-colors font-semibold text-sm\"\n                  >\n                    Tentar Novamente\n                  </button>\n                </div>\n              )}\n\n              {/* Sucesso */}\n              {showSuccess && (\n                <motion.div\n                  initial={{ opacity: 0, y: 5 }}\n                  animate={{ opacity: 1, y: 0 }}\n                  className=\"p-3 bg-green-500/10 border border-green-500/30 rounded-xl flex items-center gap-2\"\n                >\n                  <CheckCircle className=\"h-5 w-5 text-green-400 shrink-0\" />\n                  <p className=\"text-sm text-green-400 font-semibold\">Post publicado com sucesso!</p>\n                </motion.div>\n              )}\n\n              <div className=\"flex gap-3\">\n                <button\n                  type=\"button\"\n                  onClick={onClose}\n                  disabled={isLoading}\n                  className=\"flex-1 py-3 bg-white/5 border border-white/10 text-white/90 rounded-xl hover:bg-white/10 transition-colors font-medium disabled:opacity-50\"\n                >\n                  Cancelar\n                </button>\n\n                <button\n                  type=\"submit\"\n                  disabled={isLoading || cooldown > 0 || (content.trim().length === 0 && !imageFile)}\n                  className=\"flex-1 py-3 bg-[#81D8D0] text-black rounded-xl hover:bg-[#81D8D0]/90 transition-colors font-bold disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2\"\n                >\n                  {isLoading ? (\n                    <>\n                      <Loader2 className=\"h-5 w-5 animate-spin\" />\n                      {loadingText}\n                    </>\n                  ) : cooldown > 0 ? (\n                    `Aguarde ${cooldown}s`\n                  ) : (\n                    \"Publicar\"\n                  )}\n                </button>\n              </div>\n            </form>\n          </motion.div>\n        </motion.div>\n      )}\n    </AnimatePresence>\n  );\n}"
}