{
  "lote": 1,
  "status": "pending",
  "file_path": "src/app/components/WeeklyHighlights.tsx",
  "created_at": "2026-02-27T05:36:13.265Z",
  "file_content": "import { useState, useEffect } from \"react\";\nimport { motion } from \"motion/react\";\nimport { TrendingUp, MessageCircle, Flame, Users, Calendar, Loader2 } from \"lucide-react\";\nimport { supabase } from \"../../lib/supabase\";\n\ninterface HighlightPost {\n  id: string;\n  content: string;\n  author_name: string;\n  comment_count: number;\n  community_name: string | null;\n  created_at: string;\n}\n\ninterface WeeklyStats {\n  totalPosts: number;\n  totalComments: number;\n  activeMembers: number;\n  topPosts: HighlightPost[];\n  lastLive: { title: string; starts_at: string } | null;\n  nextLive: { title: string; starts_at: string } | null;\n}\n\nexport function WeeklyHighlights() {\n  const [stats, setStats] = useState<WeeklyStats | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n\n  useEffect(() => {\n    let cancelled = false;\n\n    async function loadWeeklyData() {\n      try {\n        const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();\n        const now = new Date().toISOString();\n\n        // Buscar posts da semana com contagem de comentarios\n        const { data: recentPosts } = await supabase\n          .from(\"posts\")\n          .select(\"id, content, author, community, created_at\")\n          .gte(\"created_at\", sevenDaysAgo)\n          .order(\"created_at\", { ascending: false })\n          .limit(20);\n\n        // Buscar comentarios da semana\n        const { data: recentComments } = await supabase\n          .from(\"comments\")\n          .select(\"id, post_id\")\n          .gte(\"created_at\", sevenDaysAgo);\n\n        // Contar comentarios por post\n        const commentCounts: Record<string, number> = {};\n        (recentComments || []).forEach(c => {\n          commentCounts[c.post_id] = (commentCounts[c.post_id] || 0) + 1;\n        });\n\n        // Enriquecer posts com dados de autor e comunidade\n        const authorIds = [...new Set((recentPosts || []).map(p => p.author))];\n        const communityIds = [...new Set((recentPosts || []).map(p => p.community).filter(Boolean))];\n\n        const [authorsRes, communitiesRes] = await Promise.all([\n          authorIds.length > 0\n            ? supabase.from(\"users\").select(\"id, name\").in(\"id\", authorIds)\n            : { data: [] },\n          communityIds.length > 0\n            ? supabase.from(\"communities\").select(\"id, name\").in(\"id\", communityIds as string[])\n            : { data: [] },\n        ]);\n\n        const authorMap: Record<string, string> = {};\n        (authorsRes.data || []).forEach((a: any) => { authorMap[a.id] = a.name; });\n\n        const communityMap: Record<string, string> = {};\n        (communitiesRes.data || []).forEach((c: any) => { communityMap[c.id] = c.name; });\n\n        // Top 5 posts mais comentados\n        const topPosts: HighlightPost[] = (recentPosts || [])\n          .map(p => ({\n            id: p.id,\n            content: p.content,\n            author_name: authorMap[p.author] || \"Membro\",\n            comment_count: commentCounts[p.id] || 0,\n            community_name: p.community ? communityMap[p.community] || null : null,\n            created_at: p.created_at,\n          }))\n          .sort((a, b) => b.comment_count - a.comment_count)\n          .slice(0, 5);\n\n        // Membros ativos (autores unicos)\n        const activeMembers = authorIds.length;\n\n        // Ultima live realizada\n        const { data: pastLives } = await supabase\n          .from(\"events\")\n          .select(\"title, starts_at\")\n          .lt(\"starts_at\", now)\n          .in(\"status\", [\"completed\", \"published\", \"live\"])\n          .order(\"starts_at\", { ascending: false })\n          .limit(1);\n\n        // Proxima live\n        const { data: nextLives } = await supabase\n          .from(\"events\")\n          .select(\"title, starts_at\")\n          .gte(\"starts_at\", now)\n          .in(\"status\", [\"published\"])\n          .order(\"starts_at\", { ascending: true })\n          .limit(1);\n\n        if (cancelled) return;\n\n        setStats({\n          totalPosts: (recentPosts || []).length,\n          totalComments: (recentComments || []).length,\n          activeMembers,\n          topPosts,\n          lastLive: pastLives?.[0] || null,\n          nextLive: nextLives?.[0] || null,\n        });\n      } catch (err) {\n        console.error(\"[WeeklyHighlights] Erro:\", err);\n      } finally {\n        if (!cancelled) setIsLoading(false);\n      }\n    }\n\n    loadWeeklyData();\n    return () => { cancelled = true; };\n  }, []);\n\n  function formatDate(iso: string) {\n    const d = new Date(iso);\n    const dia = d.getDate().toString().padStart(2, \"0\");\n    const mes = d.toLocaleDateString(\"pt-BR\", { month: \"short\" });\n    const hora = d.toLocaleTimeString(\"pt-BR\", { hour: \"2-digit\", minute: \"2-digit\" });\n    return `${dia} ${mes} as ${hora}`;\n  }\n\n  // Se nao tem dados nenhum, nao mostra (comunidade ainda nao tem movimento)\n  if (!isLoading && (!stats || (stats.totalPosts === 0 && !stats.lastLive && !stats.nextLive))) {\n    return null;\n  }\n\n  return (\n    <section className=\"w-full py-12 md:py-16\" style={{ background: \"#D4D4D4\" }}>\n      <div className=\"mx-auto max-w-[1200px] px-6 lg:px-8\">\n        <motion.div\n          initial={{ opacity: 0, y: 20 }}\n          whileInView={{ opacity: 1, y: 0 }}\n          viewport={{ once: true }}\n          className=\"text-center mb-8\"\n        >\n          <div className=\"inline-flex items-center gap-2 bg-[#1A1A1A] rounded-full px-4 py-2 mb-4\">\n            <TrendingUp className=\"h-4 w-4 text-[#81D8D0]\" />\n            <span className=\"text-sm text-white\" style={{ fontWeight: 700 }}>O QUE ACONTECEU ESTA SEMANA</span>\n          </div>\n        </motion.div>\n\n        {isLoading ? (\n          <div className=\"text-center py-8\">\n            <Loader2 className=\"h-6 w-6 text-[#C8102E] animate-spin mx-auto\" />\n          </div>\n        ) : stats && (\n          <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-5\">\n\n            {/* Coluna 1: Numeros da semana + Lives */}\n            <div className=\"space-y-4\">\n              {/* Numeros */}\n              <div className=\"bg-white border-2 border-[#1A1A1A]/10 rounded-2xl p-5\">\n                <h3 className=\"text-xs text-[#1A1A1A] uppercase tracking-[0.15em] mb-4\" style={{ fontWeight: 700 }}>\n                  Numeros da Semana\n                </h3>\n                <div className=\"grid grid-cols-3 gap-3\">\n                  <div className=\"text-center\">\n                    <p className=\"text-2xl text-[#1A1A1A]\" style={{ fontWeight: 800 }}>{stats.totalPosts}</p>\n                    <p className=\"text-[10px] text-[#999] uppercase\" style={{ fontWeight: 600 }}>Posts</p>\n                  </div>\n                  <div className=\"text-center\">\n                    <p className=\"text-2xl text-[#1A1A1A]\" style={{ fontWeight: 800 }}>{stats.totalComments}</p>\n                    <p className=\"text-[10px] text-[#999] uppercase\" style={{ fontWeight: 600 }}>Comentarios</p>\n                  </div>\n                  <div className=\"text-center\">\n                    <p className=\"text-2xl text-[#1A1A1A]\" style={{ fontWeight: 800 }}>{stats.activeMembers}</p>\n                    <p className=\"text-[10px] text-[#999] uppercase\" style={{ fontWeight: 600 }}>Membros Ativos</p>\n                  </div>\n                </div>\n              </div>\n\n              {/* Lives */}\n              <div className=\"bg-white border-2 border-[#1A1A1A]/10 rounded-2xl p-5\">\n                <h3 className=\"text-xs text-[#1A1A1A] uppercase tracking-[0.15em] mb-3\" style={{ fontWeight: 700 }}>\n                  Lives\n                </h3>\n                {stats.lastLive && (\n                  <div className=\"flex items-start gap-2 mb-3\">\n                    <div className=\"w-2 h-2 rounded-full bg-[#999] mt-1.5 flex-shrink-0\" />\n                    <div>\n                      <p className=\"text-xs text-[#999] uppercase\" style={{ fontWeight: 600 }}>Ultima realizada</p>\n                      <p className=\"text-sm text-[#1A1A1A]\" style={{ fontWeight: 600 }}>{stats.lastLive.title}</p>\n                      <p className=\"text-xs text-[#999]\">{formatDate(stats.lastLive.starts_at)}</p>\n                    </div>\n                  </div>\n                )}\n                {stats.nextLive && (\n                  <div className=\"flex items-start gap-2\">\n                    <motion.div\n                      animate={{ scale: [1, 1.3, 1] }}\n                      transition={{ duration: 1.5, repeat: Infinity }}\n                      className=\"w-2 h-2 rounded-full bg-[#C8102E] mt-1.5 flex-shrink-0\"\n                    />\n                    <div>\n                      <p className=\"text-xs text-[#C8102E] uppercase\" style={{ fontWeight: 600 }}>Proxima</p>\n                      <p className=\"text-sm text-[#1A1A1A]\" style={{ fontWeight: 600 }}>{stats.nextLive.title}</p>\n                      <p className=\"text-xs text-[#999]\">{formatDate(stats.nextLive.starts_at)}</p>\n                    </div>\n                  </div>\n                )}\n                {!stats.lastLive && !stats.nextLive && (\n                  <p className=\"text-xs text-[#999]\">Nenhuma live registrada ainda</p>\n                )}\n              </div>\n            </div>\n\n            {/* Coluna 2-3: Threads mais movimentadas */}\n            <div className=\"lg:col-span-2\">\n              <div className=\"bg-white border-2 border-[#1A1A1A]/10 rounded-2xl p-5\">\n                <div className=\"flex items-center gap-2 mb-4\">\n                  <Flame className=\"h-4 w-4 text-[#C8102E]\" />\n                  <h3 className=\"text-xs text-[#1A1A1A] uppercase tracking-[0.15em]\" style={{ fontWeight: 700 }}>\n                    Conversas mais movimentadas\n                  </h3>\n                </div>\n\n                {stats.topPosts.length === 0 ? (\n                  <p className=\"text-sm text-[#999] py-4 text-center\">\n                    Nenhum post esta semana ainda. Cadastre-se e comece a conversa!\n                  </p>\n                ) : (\n                  <div className=\"space-y-3\">\n                    {stats.topPosts.map((post, idx) => (\n                      <motion.div\n                        key={post.id}\n                        initial={{ opacity: 0, x: -10 }}\n                        whileInView={{ opacity: 1, x: 0 }}\n                        viewport={{ once: true }}\n                        transition={{ delay: idx * 0.06 }}\n                        className=\"flex items-start gap-3 p-3 rounded-xl hover:bg-[#F5F5F5] transition-colors\"\n                      >\n                        <span className=\"text-lg text-[#1A1A1A]/20 w-6 text-center flex-shrink-0\" style={{ fontWeight: 800 }}>\n                          {idx + 1}\n                        </span>\n                        <div className=\"flex-1 min-w-0\">\n                          <p className=\"text-sm text-[#1A1A1A] line-clamp-2 leading-snug\" style={{ fontWeight: 500 }}>\n                            {post.content.length > 120 ? post.content.slice(0, 120) + \"...\" : post.content}\n                          </p>\n                          <div className=\"flex items-center gap-3 mt-1.5 text-[10px] text-[#999]\">\n                            <span style={{ fontWeight: 600 }}>{post.author_name}</span>\n                            {post.community_name && (\n                              <span className=\"text-[#0A8F85]\">{post.community_name}</span>\n                            )}\n                            {post.comment_count > 0 && (\n                              <span className=\"flex items-center gap-1\">\n                                <MessageCircle className=\"h-3 w-3\" />\n                                {post.comment_count}\n                              </span>\n                            )}\n                          </div>\n                        </div>\n                      </motion.div>\n                    ))}\n                  </div>\n                )}\n              </div>\n            </div>\n          </div>\n        )}\n      </div>\n    </section>\n  );\n}\n"
}