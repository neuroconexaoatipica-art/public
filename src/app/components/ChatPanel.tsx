{
  "lote": 4,
  "status": "pending",
  "file_path": "src/app/components/ChatPanel.tsx",
  "created_at": "2026-02-27T05:36:22.097Z",
  "file_content": "import { useState, useRef, useEffect } from \"react\";\nimport { motion, AnimatePresence } from \"motion/react\";\nimport { Send, Loader2, MessageCircle } from \"lucide-react\";\nimport { useChat } from \"../../lib\";\nimport type { ChatMessage } from \"../../lib\";\nimport { useProfileContext } from \"../../lib\";\nimport { UserAvatar } from \"./UserAvatar\";\nimport { InlineBadges } from \"./InlineBadges\";\n\ninterface ChatPanelProps {\n  communityId: string;\n  onNavigateToProfile?: (userId: string) => void;\n}\n\nfunction timeFormat(dateStr: string): string {\n  const d = new Date(dateStr);\n  return d.toLocaleTimeString(\"pt-BR\", { hour: \"2-digit\", minute: \"2-digit\" });\n}\n\nfunction dateLabel(dateStr: string): string {\n  const d = new Date(dateStr);\n  const today = new Date();\n  if (d.toDateString() === today.toDateString()) return \"Hoje\";\n  const yesterday = new Date(today);\n  yesterday.setDate(today.getDate() - 1);\n  if (d.toDateString() === yesterday.toDateString()) return \"Ontem\";\n  return d.toLocaleDateString(\"pt-BR\", { day: \"2-digit\", month: \"2-digit\" });\n}\n\nexport function ChatPanel({ communityId, onNavigateToProfile }: ChatPanelProps) {\n  const { messages, sendMessage, isLoading } = useChat(communityId);\n  const { user } = useProfileContext();\n  const [input, setInput] = useState(\"\");\n  const [sending, setSending] = useState(false);\n  const scrollRef = useRef<HTMLDivElement>(null);\n\n  // Auto-scroll ao receber mensagem\n  useEffect(() => {\n    if (scrollRef.current) {\n      scrollRef.current.scrollTop = scrollRef.current.scrollHeight;\n    }\n  }, [messages.length]);\n\n  const handleSend = async () => {\n    if (!input.trim() || sending) return;\n    setSending(true);\n    try {\n      await sendMessage(input.trim());\n      setInput(\"\");\n    } catch (err) {\n      console.error(\"Erro ao enviar:\", err);\n    }\n    setSending(false);\n  };\n\n  const handleKeyDown = (e: React.KeyboardEvent) => {\n    if (e.key === \"Enter\" && !e.shiftKey) {\n      e.preventDefault();\n      handleSend();\n    }\n  };\n\n  // Agrupar mensagens por data\n  let lastDate = \"\";\n\n  return (\n    <div className=\"flex flex-col h-full max-h-[500px] bg-black/30 border border-white/8 rounded-xl overflow-hidden\">\n      {/* Header */}\n      <div className=\"flex items-center gap-2 px-4 py-3 border-b border-white/8 bg-white/3\">\n        <MessageCircle className=\"h-4 w-4 text-[#81D8D0]\" />\n        <h3 className=\"text-white text-sm\" style={{ fontWeight: 700 }}>Chat da Comunidade</h3>\n        <span className=\"text-white/20 text-[10px] ml-auto\">\n          {messages.length > 0 ? `${messages.length} mensagens` : \"\"}\n        </span>\n      </div>\n\n      {/* Mensagens */}\n      <div ref={scrollRef} className=\"flex-1 overflow-y-auto px-4 py-3 space-y-1\">\n        {isLoading ? (\n          <div className=\"flex items-center justify-center py-12\">\n            <Loader2 className=\"h-5 w-5 text-white/20 animate-spin\" />\n          </div>\n        ) : messages.length === 0 ? (\n          <div className=\"text-center py-12\">\n            <MessageCircle className=\"h-8 w-8 text-white/10 mx-auto mb-3\" />\n            <p className=\"text-white/30 text-sm\">Nenhuma mensagem ainda</p>\n            <p className=\"text-white/15 text-xs mt-1\">Seja a primeira pessoa a falar</p>\n          </div>\n        ) : (\n          messages.map((msg) => {\n            const isOwn = msg.author_id === user?.id;\n            const msgDate = dateLabel(msg.created_at);\n            const showDate = msgDate !== lastDate;\n            lastDate = msgDate;\n\n            return (\n              <div key={msg.id}>\n                {showDate && (\n                  <div className=\"flex items-center gap-2 py-2\">\n                    <div className=\"flex-1 h-px bg-white/5\" />\n                    <span className=\"text-white/15 text-[10px]\" style={{ fontWeight: 600 }}>{msgDate}</span>\n                    <div className=\"flex-1 h-px bg-white/5\" />\n                  </div>\n                )}\n                <motion.div\n                  initial={{ opacity: 0, y: 5 }}\n                  animate={{ opacity: 1, y: 0 }}\n                  className={`flex gap-2 py-1 ${isOwn ? \"flex-row-reverse\" : \"\"}`}\n                >\n                  {!isOwn && (\n                    <button\n                      onClick={() => onNavigateToProfile?.(msg.author_id)}\n                      className=\"flex-shrink-0 mt-1\"\n                    >\n                      <UserAvatar name={msg.author_data?.display_name || msg.author_data?.name || \"?\"} photoUrl={msg.author_data?.profile_photo} size={24} />\n                    </button>\n                  )}\n                  <div className={`max-w-[75%] ${isOwn ? \"text-right\" : \"\"}`}>\n                    {!isOwn && (\n                      <span className=\"flex items-center gap-1 mb-0.5\">\n                        <button\n                          onClick={() => onNavigateToProfile?.(msg.author_id)}\n                          className=\"text-[10px] text-white/30 hover:text-white/50 transition-colors\"\n                          style={{ fontWeight: 600 }}\n                        >\n                          {msg.author_data?.display_name || msg.author_data?.name || \"Membro\"}\n                        </button>\n                        <InlineBadges userId={msg.author_id} maxVisible={2} className=\"text-[10px]\" />\n                      </span>\n                    )}\n                    <div className={`inline-block px-3 py-2 rounded-xl text-sm ${\n                      isOwn\n                        ? \"bg-[#81D8D0]/15 text-white/90 rounded-br-md\"\n                        : \"bg-white/5 text-white/70 rounded-bl-md\"\n                    }`}>\n                      <p className=\"break-words\">{msg.content}</p>\n                    </div>\n                    <p className=\"text-[9px] text-white/15 mt-0.5 px-1\">{timeFormat(msg.created_at)}</p>\n                  </div>\n                </motion.div>\n              </div>\n            );\n          })\n        )}\n      </div>\n\n      {/* Input */}\n      <div className=\"border-t border-white/8 px-3 py-2.5\">\n        <div className=\"flex items-end gap-2\">\n          <textarea\n            value={input}\n            onChange={(e) => setInput(e.target.value)}\n            onKeyDown={handleKeyDown}\n            placeholder=\"Digite uma mensagem...\"\n            maxLength={2000}\n            rows={1}\n            className=\"flex-1 px-3 py-2 bg-white/5 border border-white/8 rounded-xl text-white text-sm placeholder:text-white/20 focus:border-white/15 focus:outline-none resize-none\"\n            style={{ minHeight: 38, maxHeight: 100 }}\n          />\n          <motion.button\n            onClick={handleSend}\n            disabled={!input.trim() || sending}\n            whileHover={{ scale: 1.05 }}\n            whileTap={{ scale: 0.95 }}\n            className=\"p-2.5 bg-[#81D8D0] rounded-xl text-[#1A1A1A] disabled:opacity-30 transition-opacity\"\n          >\n            {sending ? <Loader2 className=\"h-4 w-4 animate-spin\" /> : <Send className=\"h-4 w-4\" />}\n          </motion.button>\n        </div>\n      </div>\n    </div>\n  );\n}"
}