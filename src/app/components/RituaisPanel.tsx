{
  "lote": 4,
  "status": "pending",
  "file_path": "src/app/components/RituaisPanel.tsx",
  "created_at": "2026-02-27T05:36:28.399Z",
  "file_content": "/**\n * RituaisPanel ‚Äî Fase 2: CRUD completo de daily_challenges\n * Gerencia desafios diarios do AdminPanel sem precisar de SQL\n */\n\nimport { useState, useEffect, useCallback } from \"react\";\nimport {\n  Flame, Plus, RefreshCw, Edit3, Trash2, CheckCircle, XCircle,\n  Calendar, MessageSquare, Zap, Save\n} from \"lucide-react\";\nimport { supabase, COMMUNITY_RITUAL_TYPES } from \"../../lib\";\n\nconst CHALLENGE_TYPES = [\n  { value: 'reflexao', label: 'Reflexao', icon: 'üß†' },\n  { value: 'acao', label: 'Acao', icon: '‚ö°' },\n  { value: 'escrita', label: 'Escrita', icon: '‚úçÔ∏è' },\n  { value: 'conexao', label: 'Conexao', icon: 'ü§ù' },\n  { value: 'presenca', label: 'Presenca', icon: 'üëÅÔ∏è' },\n  { value: 'provocacao', label: 'Provocacao', icon: 'üî•' },\n  { value: 'confissao', label: 'Confissao', icon: 'üí≠' },\n];\n\ninterface AdminChallenge {\n  id: string;\n  challenge_date: string;\n  title: string;\n  description: string;\n  challenge_type: string;\n  is_active: boolean;\n  response_count: number;\n  created_at: string;\n}\n\nexport function RituaisPanel() {\n  const [challenges, setChallenges] = useState<AdminChallenge[]>([]);\n  const [isLoading, setIsLoading] = useState(true);\n  const [showCreate, setShowCreate] = useState(false);\n  const [editingId, setEditingId] = useState<string | null>(null);\n\n  // Form state\n  const [formDate, setFormDate] = useState(() => new Date().toISOString().split('T')[0]);\n  const [formTitle, setFormTitle] = useState('');\n  const [formDescription, setFormDescription] = useState('');\n  const [formType, setFormType] = useState('reflexao');\n  const [formActive, setFormActive] = useState(true);\n  const [isSaving, setIsSaving] = useState(false);\n  const [formError, setFormError] = useState('');\n\n  // Quick-fill state\n  const [fillDays, setFillDays] = useState(7);\n  const [isFilling, setIsFilling] = useState(false);\n\n  // Filter\n  const [dateFilter, setDateFilter] = useState<'all' | 'future' | 'past' | 'today'>('future');\n\n  const loadChallenges = useCallback(async () => {\n    setIsLoading(true);\n    try {\n      let query = supabase\n        .from('daily_challenges')\n        .select('*')\n        .order('challenge_date', { ascending: true })\n        .limit(200);\n\n      const today = new Date().toISOString().split('T')[0];\n      if (dateFilter === 'future') query = query.gte('challenge_date', today);\n      else if (dateFilter === 'past') query = query.lt('challenge_date', today).order('challenge_date', { ascending: false });\n      else if (dateFilter === 'today') query = query.eq('challenge_date', today);\n\n      const { data, error } = await query;\n      if (error) throw error;\n      setChallenges((data || []) as AdminChallenge[]);\n    } catch (err) {\n      console.error('[RituaisPanel] Erro ao carregar:', err);\n    } finally {\n      setIsLoading(false);\n    }\n  }, [dateFilter]);\n\n  useEffect(() => { loadChallenges(); }, [loadChallenges]);\n\n  const resetForm = () => {\n    setFormDate(new Date().toISOString().split('T')[0]);\n    setFormTitle('');\n    setFormDescription('');\n    setFormType('reflexao');\n    setFormActive(true);\n    setFormError('');\n    setEditingId(null);\n  };\n\n  const startEdit = (c: AdminChallenge) => {\n    setEditingId(c.id);\n    setFormDate(c.challenge_date);\n    setFormTitle(c.title);\n    setFormDescription(c.description);\n    setFormType(c.challenge_type);\n    setFormActive(c.is_active);\n    setShowCreate(true);\n    setFormError('');\n  };\n\n  const handleSave = async () => {\n    if (!formTitle.trim()) { setFormError('Titulo obrigatorio.'); return; }\n    if (!formDescription.trim()) { setFormError('Descricao obrigatoria.'); return; }\n    if (!formDate) { setFormError('Data obrigatoria.'); return; }\n\n    setIsSaving(true);\n    setFormError('');\n\n    try {\n      if (editingId) {\n        const { error } = await supabase\n          .from('daily_challenges')\n          .update({\n            challenge_date: formDate,\n            title: formTitle.trim(),\n            description: formDescription.trim(),\n            challenge_type: formType,\n            is_active: formActive,\n          })\n          .eq('id', editingId);\n        if (error) throw error;\n      } else {\n        const { error } = await supabase\n          .from('daily_challenges')\n          .insert({\n            challenge_date: formDate,\n            title: formTitle.trim(),\n            description: formDescription.trim(),\n            challenge_type: formType,\n            is_active: formActive,\n          });\n        if (error) throw error;\n      }\n\n      resetForm();\n      setShowCreate(false);\n      await loadChallenges();\n    } catch (err: any) {\n      console.error('[RituaisPanel] Erro ao salvar:', err);\n      setFormError(err.message || 'Erro ao salvar desafio.');\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  const deleteChallenge = async (id: string) => {\n    if (!confirm('Excluir este desafio permanentemente?')) return;\n    try {\n      const { error } = await supabase.from('daily_challenges').delete().eq('id', id);\n      if (error) throw error;\n      await loadChallenges();\n    } catch (err) {\n      console.error('[RituaisPanel] Erro ao excluir:', err);\n    }\n  };\n\n  const toggleActive = async (id: string, currentActive: boolean) => {\n    try {\n      const { error } = await supabase\n        .from('daily_challenges')\n        .update({ is_active: !currentActive })\n        .eq('id', id);\n      if (error) throw error;\n      await loadChallenges();\n    } catch (err) {\n      console.error('[RituaisPanel] Erro ao alternar:', err);\n    }\n  };\n\n  // ‚ïê‚ïê‚ïê PREENCHIMENTO RAPIDO ‚ïê‚ïê‚ïê\n  const handleQuickFill = async () => {\n    setIsFilling(true);\n    try {\n      // Buscar todos os desafios existentes como pool de templates\n      const { data: pool } = await supabase\n        .from('daily_challenges')\n        .select('title, description, challenge_type')\n        .eq('is_active', true)\n        .limit(100);\n\n      if (!pool || pool.length === 0) {\n        alert('Nenhum desafio existente para usar como template. Crie pelo menos um primeiro.');\n        setIsFilling(false);\n        return;\n      }\n\n      // Verificar quais dias ja tem desafio\n      const today = new Date();\n      const futureDates: string[] = [];\n      for (let i = 0; i < fillDays; i++) {\n        const d = new Date(today);\n        d.setDate(d.getDate() + i);\n        futureDates.push(d.toISOString().split('T')[0]);\n      }\n\n      const { data: existing } = await supabase\n        .from('daily_challenges')\n        .select('challenge_date')\n        .in('challenge_date', futureDates);\n\n      const existingDates = new Set((existing || []).map((e: any) => e.challenge_date));\n      const emptyDates = futureDates.filter(d => !existingDates.has(d));\n\n      if (emptyDates.length === 0) {\n        alert(`Todos os proximos ${fillDays} dias ja tem desafio programado!`);\n        setIsFilling(false);\n        return;\n      }\n\n      // Preencher datas vazias com templates aleatorios do pool\n      const inserts = emptyDates.map(date => {\n        const template = pool[Math.floor(Math.random() * pool.length)];\n        return {\n          challenge_date: date,\n          title: template.title,\n          description: template.description,\n          challenge_type: template.challenge_type,\n          is_active: true,\n        };\n      });\n\n      const { error } = await supabase.from('daily_challenges').insert(inserts);\n      if (error) throw error;\n\n      alert(`${inserts.length} desafio(s) criado(s) para os proximos dias!`);\n      await loadChallenges();\n    } catch (err: any) {\n      console.error('[RituaisPanel] Erro no quick-fill:', err);\n      alert('Erro ao preencher: ' + (err.message || 'Erro desconhecido'));\n    } finally {\n      setIsFilling(false);\n    }\n  };\n\n  const today = new Date().toISOString().split('T')[0];\n  const typeIcon = (type: string) => CHALLENGE_TYPES.find(t => t.value === type)?.icon || 'üß†';\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header com acoes */}\n      <div className=\"flex flex-wrap items-center justify-between gap-3\">\n        <h2 className=\"text-white font-bold flex items-center gap-2\">\n          <Flame className=\"w-5 h-5 text-[#C8102E]\" /> Rituais Diarios (daily_challenges)\n        </h2>\n        <div className=\"flex items-center gap-2\">\n          <button\n            onClick={() => { resetForm(); setShowCreate(!showCreate); }}\n            className=\"flex items-center gap-2 px-4 py-2 bg-[#C8102E] text-white rounded-xl text-xs font-bold hover:bg-[#C8102E]/90 transition-colors\"\n          >\n            <Plus className=\"w-4 h-4\" /> {showCreate ? 'Fechar' : 'Novo Desafio'}\n          </button>\n          <button onClick={loadChallenges} className=\"p-2 bg-white/5 border border-white/10 rounded-lg hover:bg-white/10 transition-colors\">\n            <RefreshCw className=\"w-4 h-4 text-white/60\" />\n          </button>\n        </div>\n      </div>\n\n      {/* Filtros */}\n      <div className=\"flex flex-wrap gap-2\">\n        {(['future', 'today', 'past', 'all'] as const).map(f => (\n          <button\n            key={f}\n            onClick={() => setDateFilter(f)}\n            className={`px-3 py-1.5 rounded-lg text-xs font-semibold border transition-colors ${\n              dateFilter === f\n                ? 'bg-[#C8102E]/15 text-[#C8102E] border-[#C8102E]/30'\n                : 'bg-white/5 text-white/40 border-white/10 hover:border-white/20'\n            }`}\n          >\n            {{ future: 'Futuros', today: 'Hoje', past: 'Passados', all: 'Todos' }[f]}\n          </button>\n        ))}\n      </div>\n\n      {/* Preenchimento Rapido */}\n      <div className=\"bg-white/5 border border-white/10 rounded-xl p-4\">\n        <h3 className=\"text-white font-semibold text-sm mb-2 flex items-center gap-2\">\n          <Zap className=\"w-4 h-4 text-[#FF6B35]\" /> Preenchimento Rapido\n        </h3>\n        <p className=\"text-white/40 text-xs mb-3\">\n          Preenche automaticamente os proximos dias vazios usando desafios existentes como pool de templates (rotacao aleatoria).\n        </p>\n        <div className=\"flex items-center gap-3\">\n          <div className=\"flex items-center gap-2\">\n            <label className=\"text-white/60 text-xs\">Proximos</label>\n            <select\n              value={fillDays}\n              onChange={(e) => setFillDays(Number(e.target.value))}\n              className=\"bg-white/5 border border-white/10 rounded-lg px-2 py-1.5 text-white text-xs focus:outline-none\"\n            >\n              <option value={7}>7 dias</option>\n              <option value={14}>14 dias</option>\n              <option value={30}>30 dias</option>\n            </select>\n          </div>\n          <button\n            onClick={handleQuickFill}\n            disabled={isFilling}\n            className=\"flex items-center gap-2 px-4 py-2 bg-[#FF6B35] text-white rounded-lg text-xs font-bold hover:bg-[#FF6B35]/90 disabled:opacity-50 transition-colors\"\n          >\n            {isFilling ? (\n              <><div className=\"w-3 h-3 border-2 border-white border-t-transparent rounded-full animate-spin\" /> Preenchendo...</>\n            ) : (\n              <><Zap className=\"w-3 h-3\" /> Preencher</>\n            )}\n          </button>\n        </div>\n      </div>\n\n      {/* Formulario de Criacao/Edicao */}\n      {showCreate && (\n        <div className=\"bg-white/5 border border-[#C8102E]/20 rounded-xl p-5 space-y-4\">\n          <h3 className=\"text-white font-semibold text-sm\">\n            {editingId ? 'Editar Desafio' : 'Novo Desafio'}\n          </h3>\n\n          <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n            <div>\n              <label className=\"text-white/60 text-xs mb-1 block\">Data</label>\n              <input\n                type=\"date\"\n                value={formDate}\n                onChange={(e) => setFormDate(e.target.value)}\n                className=\"w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-[#81D8D0]/50\"\n              />\n            </div>\n            <div>\n              <label className=\"text-white/60 text-xs mb-1 block\">Tipo</label>\n              <select\n                value={formType}\n                onChange={(e) => setFormType(e.target.value)}\n                className=\"w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm focus:outline-none\"\n              >\n                {CHALLENGE_TYPES.map(t => (\n                  <option key={t.value} value={t.value}>{t.icon} {t.label}</option>\n                ))}\n              </select>\n            </div>\n          </div>\n\n          <div>\n            <label className=\"text-white/60 text-xs mb-1 block\">Titulo</label>\n            <input\n              type=\"text\"\n              value={formTitle}\n              onChange={(e) => setFormTitle(e.target.value)}\n              placeholder=\"Ex: O silencio que voce evita\"\n              maxLength={200}\n              className=\"w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm placeholder:text-white/25 focus:outline-none focus:border-[#81D8D0]/50\"\n            />\n          </div>\n\n          <div>\n            <label className=\"text-white/60 text-xs mb-1 block\">Descricao / Provocacao</label>\n            <textarea\n              value={formDescription}\n              onChange={(e) => setFormDescription(e.target.value)}\n              placeholder=\"A pergunta, provocacao ou instrucao do ritual...\"\n              maxLength={1000}\n              rows={3}\n              className=\"w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-white text-sm placeholder:text-white/25 focus:outline-none focus:border-[#81D8D0]/50 resize-none\"\n            />\n            <p className=\"text-white/20 text-xs text-right mt-1\">{formDescription.length}/1000</p>\n          </div>\n\n          <div className=\"flex items-center gap-3\">\n            <label className=\"flex items-center gap-2 cursor-pointer\">\n              <input\n                type=\"checkbox\"\n                checked={formActive}\n                onChange={(e) => setFormActive(e.target.checked)}\n                className=\"rounded border-white/20 bg-white/5 text-[#81D8D0] focus:ring-[#81D8D0]\"\n              />\n              <span className=\"text-white/60 text-xs\">Ativo</span>\n            </label>\n          </div>\n\n          {formError && (\n            <div className=\"p-2 bg-[#C8102E]/10 border border-[#C8102E]/30 rounded-lg\">\n              <p className=\"text-[#C8102E] text-xs font-semibold\">{formError}</p>\n            </div>\n          )}\n\n          <div className=\"flex gap-3\">\n            <button\n              onClick={() => { setShowCreate(false); resetForm(); }}\n              className=\"px-4 py-2 bg-white/5 text-white/60 rounded-lg text-xs font-medium hover:bg-white/10 transition-colors\"\n            >\n              Cancelar\n            </button>\n            <button\n              onClick={handleSave}\n              disabled={isSaving}\n              className=\"flex items-center gap-2 px-5 py-2 bg-[#81D8D0] text-black rounded-lg text-xs font-bold hover:bg-[#81D8D0]/90 disabled:opacity-50 transition-colors\"\n            >\n              {isSaving ? (\n                <><div className=\"w-3 h-3 border-2 border-black border-t-transparent rounded-full animate-spin\" /> Salvando...</>\n              ) : (\n                <><Save className=\"w-3 h-3\" /> {editingId ? 'Atualizar' : 'Criar Desafio'}</>\n              )}\n            </button>\n          </div>\n        </div>\n      )}\n\n      {/* Lista de Desafios */}\n      {isLoading ? (\n        <div className=\"flex justify-center py-12\">\n          <div className=\"w-8 h-8 border-2 border-[#C8102E] border-t-transparent rounded-full animate-spin\" />\n        </div>\n      ) : challenges.length === 0 ? (\n        <div className=\"text-center py-12 bg-white/5 rounded-2xl border border-white/10\">\n          <Flame className=\"w-10 h-10 mx-auto mb-3 text-white opacity-30\" />\n          <p className=\"text-white/60 text-sm\">\n            {dateFilter === 'future' ? 'Nenhum desafio programado. Crie um ou use o preenchimento rapido!' : 'Nenhum desafio encontrado para este filtro.'}\n          </p>\n        </div>\n      ) : (\n        <div className=\"space-y-2\">\n          {challenges.map((c) => {\n            const isToday = c.challenge_date === today;\n            const isPast = c.challenge_date < today;\n            return (\n              <div\n                key={c.id}\n                className={`bg-white/5 border rounded-xl p-4 transition-all ${\n                  isToday ? 'border-[#C8102E]/40 bg-[#C8102E]/5' :\n                  !c.is_active ? 'border-white/5 opacity-50' :\n                  isPast ? 'border-white/10 opacity-70' :\n                  'border-white/10'\n                }`}\n              >\n                <div className=\"flex items-start justify-between gap-3\">\n                  <div className=\"flex items-start gap-3 flex-1 min-w-0\">\n                    <span className=\"text-2xl flex-shrink-0 mt-0.5\">{typeIcon(c.challenge_type)}</span>\n                    <div className=\"flex-1 min-w-0\">\n                      <div className=\"flex items-center gap-2 mb-1 flex-wrap\">\n                        <h4 className=\"text-white font-semibold text-sm\">{c.title}</h4>\n                        {isToday && (\n                          <span className=\"text-[9px] px-2 py-0.5 bg-[#C8102E] text-white rounded-full font-bold animate-pulse\">HOJE</span>\n                        )}\n                        <span className={`text-[10px] px-2 py-0.5 rounded-full font-medium ${\n                          c.is_active ? 'bg-[#81D8D0]/20 text-[#81D8D0]' : 'bg-white/10 text-white/40'\n                        }`}>\n                          {c.is_active ? 'ATIVO' : 'INATIVO'}\n                        </span>\n                        <span className=\"text-[10px] px-2 py-0.5 bg-white/10 text-white/40 rounded-full\">\n                          {CHALLENGE_TYPES.find(t => t.value === c.challenge_type)?.label || c.challenge_type}\n                        </span>\n                      </div>\n                      <p className=\"text-white/50 text-xs leading-relaxed line-clamp-2\">{c.description}</p>\n                      <div className=\"flex items-center gap-3 mt-2 text-xs text-white/30\">\n                        <span className=\"flex items-center gap-1\">\n                          <Calendar className=\"w-3 h-3\" />\n                          {new Date(c.challenge_date + 'T12:00:00').toLocaleDateString('pt-BR', { weekday: 'short', day: '2-digit', month: 'short' })}\n                        </span>\n                        {c.response_count > 0 && (\n                          <span className=\"flex items-center gap-1\">\n                            <MessageSquare className=\"w-3 h-3\" />\n                            {c.response_count} resposta{c.response_count !== 1 ? 's' : ''}\n                          </span>\n                        )}\n                      </div>\n                    </div>\n                  </div>\n                  <div className=\"flex items-center gap-1 flex-shrink-0\">\n                    <button\n                      onClick={() => startEdit(c)}\n                      className=\"p-2 hover:bg-white/10 rounded-lg transition-colors\"\n                      title=\"Editar\"\n                    >\n                      <Edit3 className=\"w-3.5 h-3.5 text-white/40 hover:text-[#81D8D0]\" />\n                    </button>\n                    <button\n                      onClick={() => toggleActive(c.id, c.is_active)}\n                      className=\"p-2 hover:bg-white/10 rounded-lg transition-colors\"\n                      title={c.is_active ? 'Desativar' : 'Ativar'}\n                    >\n                      {c.is_active ? (\n                        <XCircle className=\"w-3.5 h-3.5 text-white/40 hover:text-amber-400\" />\n                      ) : (\n                        <CheckCircle className=\"w-3.5 h-3.5 text-white/40 hover:text-[#81D8D0]\" />\n                      )}\n                    </button>\n                    <button\n                      onClick={() => deleteChallenge(c.id)}\n                      className=\"p-2 hover:bg-[#C8102E]/20 rounded-lg transition-colors\"\n                      title=\"Excluir\"\n                    >\n                      <Trash2 className=\"w-3.5 h-3.5 text-white/40 hover:text-[#C8102E]\" />\n                    </button>\n                  </div>\n                </div>\n              </div>\n            );\n          })}\n        </div>\n      )}\n\n      {/* Info */}\n      <div className=\"bg-white/5 border border-white/10 rounded-xl p-4\">\n        <p className=\"text-white/40 text-xs leading-relaxed\">\n          <strong className=\"text-white/60\">Como funciona:</strong> Cada dia pode ter um desafio ativo. O desafio aparece no \"Ritual do Dia\" para todos os membros logados.\n          Se nao houver desafio para o dia, um check-in livre e exibido.\n          Use o <strong className=\"text-[#FF6B35]\">Preenchimento Rapido</strong> para preencher automaticamente dias futuros usando desafios existentes como banco de inspiracao.\n        </p>\n      </div>\n\n      {/* ‚ïê‚ïê‚ïê SECAO 2: Rituais de Comunidade (tipos disponiveis) ‚ïê‚ïê‚ïê */}\n      <div className=\"mt-8 pt-6 border-t border-white/10\">\n        <h2 className=\"text-white font-bold flex items-center gap-2 mb-4\">\n          <span className=\"text-lg\">üßò</span> Rituais de Comunidade\n        </h2>\n        <p className=\"text-white/40 text-xs mb-4 leading-relaxed\">\n          Estes sao os tipos de ritual disponiveis dentro de cada comunidade (aba \"Rituais\"). Estao definidos em <code className=\"text-[#81D8D0]\">communitiesConfig.ts</code>.\n          Para agendar um ritual, use a aba <strong className=\"text-white/60\">Eventos & Lives</strong> com <code className=\"text-[#81D8D0]\">event_type: \"ritual\"</code>.\n        </p>\n        <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-3\">\n          {COMMUNITY_RITUAL_TYPES.map((ritual) => (\n            <div key={ritual.key} className=\"bg-white/5 border border-white/10 rounded-xl p-4 hover:border-[#81D8D0]/20 transition-colors\">\n              <div className=\"flex items-center gap-2 mb-2\">\n                <span className=\"text-xl\">{ritual.icone}</span>\n                <h4 className=\"text-white font-semibold text-sm\">{ritual.nome}</h4>\n              </div>\n              <p className=\"text-white/50 text-xs leading-relaxed\">{ritual.desc}</p>\n              <p className=\"text-white/20 text-[10px] mt-2 font-mono\">{ritual.key}</p>\n            </div>\n          ))}\n        </div>\n      </div>\n    </div>\n  );\n}\n"
}