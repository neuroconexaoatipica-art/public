{
  "lote": 4,
  "status": "pending",
  "file_path": "src/app/components/AgendaViva.tsx",
  "created_at": "2026-02-27T05:36:24.858Z",
  "file_content": "/**\n * AgendaViva — Agenda compacta de eventos com contagem regressiva\n * \n * Mostra os próximos eventos/lives de TODAS as comunidades em formato\n * de timeline vertical. Pode ser usado na landing (sem login) ou\n * dentro da área interna.\n */\n\nimport { useState, useEffect, forwardRef } from \"react\";\nimport { motion } from \"motion/react\";\nimport { Calendar, Clock, Radio, Users, MapPin, Flame, Sparkles } from \"lucide-react\";\nimport { supabase } from \"../../lib/supabase\";\n\ninterface AgendaEvent {\n  id: string;\n  title: string;\n  description: string;\n  event_type: \"live\" | \"workshop\" | \"ritual\" | \"meetup\" | \"study_group\" | \"support_circle\";\n  starts_at: string;\n  ends_at: string | null;\n  community_name: string | null;\n  community_color: string;\n  participant_count: number;\n  location_type: \"online\" | \"in_person\" | \"hybrid\";\n  host_name: string | null;\n}\n\nfunction getCountdown(startsAt: string): string {\n  const now = new Date();\n  const start = new Date(startsAt);\n  const diff = start.getTime() - now.getTime();\n\n  if (diff <= 0) return \"Agora!\";\n\n  const days = Math.floor(diff / (1000 * 60 * 60 * 24));\n  const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));\n  const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));\n\n  if (days > 0) return `${days}d ${hours}h`;\n  if (hours > 0) return `${hours}h ${minutes}min`;\n  return `${minutes}min`;\n}\n\nfunction getEventIcon(type: string) {\n  switch (type) {\n    case \"live\": return Radio;\n    case \"ritual\": return Flame;\n    case \"workshop\": return Sparkles;\n    default: return Calendar;\n  }\n}\n\nfunction getEventTypeLabel(type: string) {\n  switch (type) {\n    case \"live\": return \"Live\";\n    case \"ritual\": return \"Ritual\";\n    case \"workshop\": return \"Workshop\";\n    case \"meetup\": return \"Encontro\";\n    case \"study_group\": return \"Grupo de Estudo\";\n    case \"support_circle\": return \"Circulo de Apoio\";\n    default: return \"Evento\";\n  }\n}\n\n// Cores por tipo de evento\nfunction getEventColor(type: string): string {\n  switch (type) {\n    case \"live\": return \"#C8102E\";\n    case \"ritual\": return \"#FF6B35\";\n    case \"workshop\": return \"#81D8D0\";\n    default: return \"#999\";\n  }\n}\n\nexport const AgendaViva = forwardRef<HTMLElement>(\n  function AgendaViva(_props, ref) {\n    const [events, setEvents] = useState<AgendaEvent[]>([]);\n    const [isLoading, setIsLoading] = useState(true);\n    const [countdown, setCountdown] = useState<Record<string, string>>({});\n\n    // Carregar próximos eventos\n    useEffect(() => {\n      async function loadEvents() {\n        try {\n          const now = new Date().toISOString();\n          const { data, error } = await supabase\n            .from(\"events\")\n            .select(`\n              id, title, description, event_type, starts_at, ends_at,\n              location_type, host_id,\n              communities!events_community_id_fkey(name)\n            `)\n            .gte(\"starts_at\", now)\n            .eq(\"status\", \"scheduled\")\n            .order(\"starts_at\", { ascending: true })\n            .limit(8);\n\n          if (error) {\n            console.error(\"[AgendaViva] Erro ao carregar eventos:\", error);\n            return;\n          }\n\n          if (data && data.length > 0) {\n            // Carregar contagem de participantes\n            const eventIds = data.map((e: any) => e.id);\n            const { data: participants } = await supabase\n              .from(\"event_participants\")\n              .select(\"event_id\")\n              .in(\"event_id\", eventIds);\n\n            const countMap: Record<string, number> = {};\n            (participants || []).forEach((p: any) => {\n              countMap[p.event_id] = (countMap[p.event_id] || 0) + 1;\n            });\n\n            // Carregar nomes dos hosts\n            const hostIds = [...new Set(data.map((e: any) => e.host_id).filter(Boolean))];\n            const hostMap: Record<string, string> = {};\n            if (hostIds.length > 0) {\n              const { data: hosts } = await supabase\n                .from(\"users\")\n                .select(\"id, name\")\n                .in(\"id\", hostIds);\n              (hosts || []).forEach((h: any) => { hostMap[h.id] = h.name; });\n            }\n\n            const mapped: AgendaEvent[] = data.map((e: any) => ({\n              id: e.id,\n              title: e.title,\n              description: e.description,\n              event_type: e.event_type,\n              starts_at: e.starts_at,\n              ends_at: e.ends_at,\n              community_name: e.communities?.name || null,\n              community_color: getEventColor(e.event_type),\n              participant_count: countMap[e.id] || 0,\n              location_type: e.location_type || \"online\",\n              host_name: e.host_id ? (hostMap[e.host_id] || null) : null,\n            }));\n\n            setEvents(mapped);\n          }\n        } catch (err) {\n          console.error(\"[AgendaViva] Erro:\", err);\n        } finally {\n          setIsLoading(false);\n        }\n      }\n\n      loadEvents();\n    }, []);\n\n    // Atualizar contagem regressiva a cada minuto\n    useEffect(() => {\n      function updateCountdowns() {\n        const newCountdowns: Record<string, string> = {};\n        events.forEach(e => {\n          newCountdowns[e.id] = getCountdown(e.starts_at);\n        });\n        setCountdown(newCountdowns);\n      }\n\n      updateCountdowns();\n      const interval = setInterval(updateCountdowns, 60_000);\n      return () => clearInterval(interval);\n    }, [events]);\n\n    if (isLoading) {\n      return (\n        <section ref={ref} className=\"w-full py-10\" style={{ background: \"#D4D4D4\" }}>\n          <div className=\"mx-auto max-w-[1200px] px-6\">\n            <div className=\"flex items-center justify-center py-12\">\n              <div className=\"w-8 h-8 border-3 border-[#C8102E] border-t-transparent rounded-full animate-spin\" />\n            </div>\n          </div>\n        </section>\n      );\n    }\n\n    if (events.length === 0) {\n      return null; // Nao mostra se nao tem eventos\n    }\n\n    return (\n      <section ref={ref} className=\"w-full py-10 md:py-14\" style={{ background: \"#D4D4D4\" }}>\n        <div className=\"mx-auto max-w-[1200px] px-6 lg:px-8\">\n          {/* Header */}\n          <motion.div\n            initial={{ opacity: 0, y: 20 }}\n            whileInView={{ opacity: 1, y: 0 }}\n            viewport={{ once: true }}\n            className=\"text-center mb-8\"\n          >\n            <h2 className=\"text-2xl md:text-3xl text-[#1A1A1A] mb-2\" style={{ fontWeight: 700 }}>\n              Agenda Viva\n            </h2>\n            <p className=\"text-[#555] text-sm md:text-base\">\n              Proximos encontros do territorio. Tudo acontecendo de verdade.\n            </p>\n          </motion.div>\n\n          {/* Timeline de eventos */}\n          <div className=\"space-y-3 max-w-[700px] mx-auto\">\n            {events.map((event, idx) => {\n              const IconComp = getEventIcon(event.event_type);\n              const color = event.community_color;\n              const startDate = new Date(event.starts_at);\n              const isToday = new Date().toDateString() === startDate.toDateString();\n              const isTomorrow = new Date(Date.now() + 86400000).toDateString() === startDate.toDateString();\n              const dayLabel = isToday ? \"Hoje\" : isTomorrow ? \"Amanha\" : startDate.toLocaleDateString(\"pt-BR\", { weekday: \"short\", day: \"numeric\", month: \"short\" });\n\n              return (\n                <motion.div\n                  key={event.id}\n                  initial={{ opacity: 0, x: -20 }}\n                  whileInView={{ opacity: 1, x: 0 }}\n                  viewport={{ once: true }}\n                  transition={{ duration: 0.4, delay: idx * 0.08 }}\n                  className=\"flex items-stretch gap-4\"\n                >\n                  {/* Timeline dot + line */}\n                  <div className=\"flex flex-col items-center w-8 flex-shrink-0\">\n                    <div\n                      className=\"w-4 h-4 rounded-full border-3 mt-4 flex-shrink-0\"\n                      style={{ borderColor: color, backgroundColor: isToday ? color : \"transparent\" }}\n                    />\n                    {idx < events.length - 1 && (\n                      <div className=\"w-0.5 flex-1 bg-[#1A1A1A]/10 mt-1\" />\n                    )}\n                  </div>\n\n                  {/* Card */}\n                  <div className=\"flex-1 bg-white rounded-xl p-4 border border-[#1A1A1A]/8 shadow-sm hover:shadow-md transition-shadow mb-1\">\n                    <div className=\"flex items-start justify-between gap-3\">\n                      <div className=\"flex-1 min-w-0\">\n                        {/* Type + Community */}\n                        <div className=\"flex items-center gap-2 mb-1.5\">\n                          <span\n                            className=\"inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] uppercase tracking-wider text-white\"\n                            style={{ background: color, fontWeight: 700 }}\n                          >\n                            <IconComp className=\"h-2.5 w-2.5\" />\n                            {getEventTypeLabel(event.event_type)}\n                          </span>\n                          {event.community_name && (\n                            <span className=\"text-[10px] text-[#555] font-medium truncate\">\n                              {event.community_name}\n                            </span>\n                          )}\n                        </div>\n\n                        {/* Title */}\n                        <h3 className=\"text-sm text-[#1A1A1A] leading-snug\" style={{ fontWeight: 600 }}>\n                          {event.title}\n                        </h3>\n\n                        {/* Meta */}\n                        <div className=\"flex items-center gap-3 mt-2 text-[11px] text-[#777]\">\n                          <span className=\"flex items-center gap-1\">\n                            <Calendar className=\"h-3 w-3\" />\n                            {dayLabel}\n                          </span>\n                          <span className=\"flex items-center gap-1\">\n                            <Clock className=\"h-3 w-3\" />\n                            {startDate.toLocaleTimeString(\"pt-BR\", { hour: \"2-digit\", minute: \"2-digit\" })}\n                          </span>\n                          {event.participant_count > 0 && (\n                            <span className=\"flex items-center gap-1\">\n                              <Users className=\"h-3 w-3\" />\n                              {event.participant_count}\n                            </span>\n                          )}\n                          {event.location_type === \"in_person\" && (\n                            <span className=\"flex items-center gap-1\">\n                              <MapPin className=\"h-3 w-3\" />\n                              Presencial\n                            </span>\n                          )}\n                        </div>\n\n                        {event.host_name && (\n                          <p className=\"text-[10px] text-[#999] mt-1.5\">\n                            com {event.host_name}\n                          </p>\n                        )}\n                      </div>\n\n                      {/* Countdown */}\n                      <div className=\"flex-shrink-0 text-right\">\n                        <div\n                          className=\"text-xs px-2.5 py-1.5 rounded-lg font-bold\"\n                          style={{\n                            background: `${color}15`,\n                            color: color,\n                          }}\n                        >\n                          {countdown[event.id] || \"...\"}\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                </motion.div>\n              );\n            })}\n          </div>\n        </div>\n      </section>\n    );\n  }\n);\n"
}