{
  "lote": 2,
  "status": "pending",
  "file_path": "src/app/components/OnboardingFlow.tsx",
  "created_at": "2026-02-27T05:36:16.376Z",
  "file_content": "import { useState, useEffect } from \"react\";\nimport { motion, AnimatePresence } from \"motion/react\";\nimport { X, ArrowRight, ArrowLeft, CheckCircle, Loader2, Shield } from \"lucide-react\";\nimport { supabase, COMMUNITIES_CONFIG } from \"../../lib\";\n\ninterface OnboardingFlowProps {\n  isOpen: boolean;\n  onClose: () => void;\n  onComplete: () => void;\n}\n\nexport function OnboardingFlow({ isOpen, onClose, onComplete }: OnboardingFlowProps) {\n  const [currentStep, setCurrentStep] = useState(0);\n  const [displayName, setDisplayName] = useState(\"\");\n  const [shortBio, setShortBio] = useState(\"\");\n  const [selectedCommunities, setSelectedCommunities] = useState<string[]>([]);\n  const [isSubmitting, setIsSubmitting] = useState(false);\n  const [ethicalAccepted, setEthicalAccepted] = useState(false);\n\n  const totalSteps = 3;\n\n  // Pré-preencher nome do auth metadata quando abre\n  useEffect(() => {\n    if (!isOpen) return;\n\n    // Reset estado ao abrir\n    setCurrentStep(0);\n    setShortBio(\"\");\n    setSelectedCommunities([]);\n    setIsSubmitting(false);\n    setEthicalAccepted(false);\n\n    const loadName = async () => {\n      try {\n        const { data: { user } } = await supabase.auth.getUser();\n        if (user?.user_metadata?.name) {\n          setDisplayName(user.user_metadata.name);\n        } else {\n          setDisplayName(\"\");\n        }\n      } catch {\n        setDisplayName(\"\");\n      }\n    };\n\n    loadName();\n  }, [isOpen]);\n\n  const toggleCommunity = (communityName: string) => {\n    setSelectedCommunities(prev =>\n      prev.includes(communityName)\n        ? prev.filter(n => n !== communityName)\n        : [...prev, communityName]\n    );\n  };\n\n  const canProceed = () => {\n    if (currentStep === 0) return displayName.trim().length >= 2;\n    if (currentStep === 1) return selectedCommunities.length >= 1;\n    if (currentStep === 2) return ethicalAccepted;\n    return false;\n  };\n\n  const handleNext = () => {\n    if (currentStep < totalSteps - 1) {\n      setCurrentStep(currentStep + 1);\n    } else {\n      handleFinalize();\n    }\n  };\n\n  const handleBack = () => {\n    if (currentStep > 0) {\n      setCurrentStep(currentStep - 1);\n    }\n  };\n\n  const handleFinalize = async () => {\n    setIsSubmitting(true);\n\n    try {\n      const { data: { session } } = await supabase.auth.getSession();\n\n      if (session?.user) {\n        const onboardingPayload = {\n          display_name: displayName.trim(),\n          short_bio: shortBio.trim() || null,\n          interested_communities: selectedCommunities,\n          ethical_accepted: true,\n          ethical_accepted_at: new Date().toISOString(),\n          onboarded_at: new Date().toISOString()\n        };\n\n        const { error } = await supabase\n          .from('users')\n          .update({\n            name: displayName.trim(),\n            bio: shortBio.trim() || null,\n          })\n          .eq('id', session.user.id);\n\n        if (error) {\n          console.error('Erro ao salvar onboarding:', error);\n          // Não bloqueia — dados de boas-vindas, não gate de segurança\n        }\n      }\n    } catch (err) {\n      console.error('Erro no onboarding:', err);\n      // Não bloqueia\n    }\n\n    setIsSubmitting(false);\n    onComplete();\n  };\n\n  return (\n    <AnimatePresence>\n      {isOpen && (\n        <motion.div\n          initial={{ opacity: 0 }}\n          animate={{ opacity: 1 }}\n          exit={{ opacity: 0 }}\n          className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-sm p-4\"\n          onClick={onClose}\n        >\n          <motion.div\n            initial={{ opacity: 0, scale: 0.95, y: 20 }}\n            animate={{ opacity: 1, scale: 1, y: 0 }}\n            exit={{ opacity: 0, scale: 0.95, y: 20 }}\n            transition={{ duration: 0.3 }}\n            onClick={(e) => e.stopPropagation()}\n            className=\"relative w-full max-w-2xl bg-white rounded-2xl shadow-2xl overflow-hidden\"\n          >\n            {/* Header */}\n            <div className=\"bg-[#35363A] px-8 py-6 relative\">\n              <button\n                onClick={onClose}\n                className=\"absolute top-4 right-4 p-2 hover:bg-white/10 rounded-lg transition-colors\"\n              >\n                <X className=\"h-5 w-5 text-white\" />\n              </button>\n\n              <h2 className=\"text-2xl font-semibold text-white\">\n                {currentStep === 0\n                  ? \"Bem-vindo(a) ao NeuroConexão Atípica\"\n                  : currentStep === 1\n                  ? \"O que te interessa?\"\n                  : \"Aceite ético\"\n                }\n              </h2>\n              <p className=\"text-white/70 mt-2 font-normal\">\n                Etapa {currentStep + 1} de {totalSteps}\n              </p>\n\n              {/* Progress bar */}\n              <div className=\"mt-4 h-1 bg-white/20 rounded-full overflow-hidden\">\n                <motion.div\n                  initial={{ width: 0 }}\n                  animate={{ width: `${((currentStep + 1) / totalSteps) * 100}%` }}\n                  transition={{ duration: 0.3 }}\n                  className=\"h-full bg-[#81D8D0]\"\n                />\n              </div>\n            </div>\n\n            {/* Content */}\n            <div className=\"px-8 py-8 max-h-[60vh] overflow-y-auto\">\n              <AnimatePresence mode=\"wait\">\n\n                {/* ETAPA 1: Boas-vindas + Nome + Bio opcional */}\n                {currentStep === 0 && (\n                  <motion.div\n                    key=\"step1\"\n                    initial={{ opacity: 0, x: 20 }}\n                    animate={{ opacity: 1, x: 0 }}\n                    exit={{ opacity: 0, x: -20 }}\n                    className=\"space-y-6\"\n                  >\n                    <div>\n                      <h3 className=\"text-2xl font-semibold text-[#35363A] mb-2\">\n                        Que bom ter você aqui!\n                      </h3>\n                      <p className=\"text-[#35363A]/70 font-normal\">\n                        Vamos personalizar sua experiência. É rápido — 2 passos e você já está dentro.\n                      </p>\n                    </div>\n\n                    {/* Nome */}\n                    <div>\n                      <label className=\"block text-sm font-medium text-[#35363A] mb-2\">\n                        Como quer ser chamado(a)?\n                      </label>\n                      <input\n                        type=\"text\"\n                        value={displayName}\n                        onChange={(e) => setDisplayName(e.target.value)}\n                        placeholder=\"Seu nome ou apelido\"\n                        className=\"w-full px-4 py-3 border-2 border-[#35363A]/15 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#81D8D0] focus:border-transparent transition-all text-[#35363A]\"\n                      />\n                      {displayName.length > 0 && displayName.trim().length < 2 && (\n                        <p className=\"text-xs text-[#C8102E] mt-1\">Mínimo 2 caracteres</p>\n                      )}\n                    </div>\n\n                    {/* Bio opcional */}\n                    <div>\n                      <label className=\"block text-sm font-medium text-[#35363A] mb-2\">\n                        Uma frase sobre você\n                        <span className=\"text-[#35363A]/40 font-normal ml-1\">(opcional)</span>\n                      </label>\n                      <textarea\n                        value={shortBio}\n                        onChange={(e) => setShortBio(e.target.value)}\n                        placeholder=\"O que te trouxe aqui? Como você se define?\"\n                        rows={3}\n                        maxLength={280}\n                        className=\"w-full px-4 py-3 border-2 border-[#35363A]/15 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#81D8D0] focus:border-transparent resize-none transition-all text-[#35363A]\"\n                      />\n                      {shortBio.length > 0 && (\n                        <p className=\"text-xs text-[#35363A]/40 mt-1\">\n                          {shortBio.length}/280 caracteres\n                        </p>\n                      )}\n                    </div>\n\n                    {/* Nota de segurança */}\n                    <div className=\"flex items-start gap-3 bg-[#81D8D0]/10 border border-[#81D8D0]/30 rounded-xl p-4\">\n                      <Shield className=\"h-5 w-5 text-[#81D8D0] flex-shrink-0 mt-0.5\" />\n                      <p className=\"text-sm text-[#35363A]/70 font-normal\">\n                        Seus dados ficam seguros. Nada é compartilhado publicamente sem sua permissão.\n                      </p>\n                    </div>\n                  </motion.div>\n                )}\n\n                {/* ETAPA 2: Comunidades de interesse */}\n                {currentStep === 1 && (\n                  <motion.div\n                    key=\"step2\"\n                    initial={{ opacity: 0, x: 20 }}\n                    animate={{ opacity: 1, x: 0 }}\n                    exit={{ opacity: 0, x: -20 }}\n                    className=\"space-y-6\"\n                  >\n                    <div>\n                      <h3 className=\"text-2xl font-semibold text-[#35363A] mb-2\">\n                        Escolha suas comunidades\n                      </h3>\n                      <p className=\"text-[#35363A]/70 font-normal\">\n                        Selecione as que mais combinam com você. Pode mudar depois, sem compromisso.\n                      </p>\n                    </div>\n\n                    {/* Grid de comunidades */}\n                    <div className=\"grid grid-cols-2 sm:grid-cols-3 gap-3\">\n                      {COMMUNITIES_CONFIG.map((community) => {\n                        const isSelected = selectedCommunities.includes(community.name);\n                        const IconComponent = community.icon;\n                        return (\n                          <button\n                            key={community.name}\n                            onClick={() => toggleCommunity(community.name)}\n                            className=\"text-left p-4 border-2 rounded-xl transition-all relative\"\n                            style={{\n                              borderColor: isSelected ? community.color : 'rgba(53,54,58,0.12)',\n                              backgroundColor: isSelected ? `${community.color}12` : 'transparent'\n                            }}\n                          >\n                            <div className=\"flex flex-col gap-1.5\">\n                              <div className=\"flex items-center justify-between\">\n                                <IconComponent\n                                  className=\"h-5 w-5\"\n                                  style={{ color: community.color }}\n                                />\n                                {isSelected && (\n                                  <CheckCircle\n                                    className=\"h-5 w-5 flex-shrink-0\"\n                                    style={{ color: community.color }}\n                                  />\n                                )}\n                              </div>\n                              <h4 className=\"font-semibold text-[#35363A] text-sm\">\n                                {community.name}\n                              </h4>\n                              <p className=\"text-xs text-[#35363A]/60 font-normal leading-snug\">\n                                {community.description}\n                              </p>\n                            </div>\n                          </button>\n                        );\n                      })}\n                    </div>\n\n                    {/* Contador */}\n                    <div className=\"text-center\">\n                      <p className=\"text-sm text-[#35363A]/60 font-normal\">\n                        {selectedCommunities.length === 0 ? (\n                          \"Selecione ao menos 1 comunidade\"\n                        ) : (\n                          <>\n                            <span className=\"font-semibold text-[#35363A]\">\n                              {selectedCommunities.length}\n                            </span>\n                            {\" \"}\n                            {selectedCommunities.length === 1\n                              ? \"comunidade selecionada\"\n                              : \"comunidades selecionadas\"\n                            }\n                          </>\n                        )}\n                      </p>\n                    </div>\n                  </motion.div>\n                )}\n\n                {/* ETAPA 3: Aceite ético */}\n                {currentStep === 2 && (\n                  <motion.div\n                    key=\"step3\"\n                    initial={{ opacity: 0, x: 20 }}\n                    animate={{ opacity: 1, x: 0 }}\n                    exit={{ opacity: 0, x: -20 }}\n                    className=\"space-y-6\"\n                  >\n                    <div>\n                      <h3 className=\"text-2xl font-semibold text-[#35363A] mb-2\">\n                        Princípios do espaço\n                      </h3>\n                      <p className=\"text-[#35363A]/70 font-normal\">\n                        Antes de entrar, leia e aceite os princípios que sustentam este campo.\n                      </p>\n                    </div>\n\n                    <div className=\"bg-[#35363A]/5 border border-[#35363A]/10 rounded-xl p-6 space-y-4 text-[#35363A]/80 text-sm leading-relaxed\">\n                      <p className=\"font-semibold text-[#35363A] text-base\">\n                        Este não é um espaço de terapia, nem de consumo passivo.\n                      </p>\n                      <p>\n                        Aqui, presença importa. Respeito não é opcional. Intensidade é bem-vinda, violência não.\n                      </p>\n                      <p>\n                        Não romantize caos, trauma ou autodestruição. Isso não é acolhimento.\n                      </p>\n                      <p>\n                        Falar direto não é desculpa para agressão. Discordância é permitida. Opacidade não.\n                      </p>\n                      <p>\n                        Moderação é humana. Denúncias são levadas a sério.\n                      </p>\n                      <p className=\"font-semibold text-[#C8102E]\">\n                        Se você não se identifica com esses princípios, este espaço não é para você.\n                      </p>\n                    </div>\n\n                    <div className=\"flex items-start gap-3 pt-2\">\n                      <input\n                        type=\"checkbox\"\n                        id=\"ethical-accept\"\n                        checked={ethicalAccepted}\n                        onChange={(e) => setEthicalAccepted(e.target.checked)}\n                        className=\"mt-1 h-5 w-5 rounded border-2 border-[#35363A]/30 text-[#81D8D0] focus:ring-[#81D8D0] accent-[#81D8D0] cursor-pointer\"\n                      />\n                      <label htmlFor=\"ethical-accept\" className=\"text-sm text-[#35363A] cursor-pointer leading-relaxed font-medium\">\n                        Li, compreendo e aceito os princípios deste espaço. Entendo que o descumprimento pode resultar em suspensão.\n                      </label>\n                    </div>\n                  </motion.div>\n                )}\n\n              </AnimatePresence>\n            </div>\n\n            {/* Footer com botões */}\n            <div className=\"bg-[#35363A]/5 px-8 py-6 flex items-center justify-between border-t border-[#35363A]/10\">\n              {currentStep > 0 ? (\n                <button\n                  onClick={handleBack}\n                  disabled={isSubmitting}\n                  className=\"flex items-center gap-2 px-5 py-2.5 rounded-xl font-semibold text-[#35363A] hover:bg-[#35363A]/10 transition-all disabled:opacity-50\"\n                >\n                  <ArrowLeft className=\"h-5 w-5\" />\n                  Voltar\n                </button>\n              ) : (\n                <div />\n              )}\n\n              <button\n                onClick={handleNext}\n                disabled={!canProceed() || isSubmitting}\n                className={`flex items-center gap-2 px-6 py-3 rounded-xl font-bold transition-all ${\n                  canProceed() && !isSubmitting\n                    ? \"bg-[#81D8D0] text-black hover:bg-[#81D8D0]/90 shadow-lg hover:shadow-xl\"\n                    : \"bg-[#35363A]/20 text-[#35363A]/40 cursor-not-allowed\"\n                }`}\n              >\n                {isSubmitting ? (\n                  <>\n                    <Loader2 className=\"h-5 w-5 animate-spin\" />\n                    Salvando...\n                  </>\n                ) : currentStep === totalSteps - 1 ? (\n                  <>\n                    Finalizar\n                    <CheckCircle className=\"h-5 w-5\" />\n                  </>\n                ) : (\n                  <>\n                    Continuar\n                    <ArrowRight className=\"h-5 w-5\" />\n                  </>\n                )}\n              </button>\n            </div>\n          </motion.div>\n        </motion.div>\n      )}\n    </AnimatePresence>\n  );\n}"
}