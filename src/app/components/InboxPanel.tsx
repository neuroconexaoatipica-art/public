{
  "lote": 4,
  "status": "pending",
  "file_path": "src/app/components/InboxPanel.tsx",
  "created_at": "2026-02-27T05:36:28.238Z",
  "file_content": "/**\n * InboxPanel â€” Caixa de Entrada do Admin\n * Le contact_requests com filtro por tipo, marcar como resolvido, busca\n */\n\nimport { useState, useEffect, useCallback } from \"react\";\nimport {\n  Inbox, RefreshCw, CheckCircle, XCircle, Search, Filter,\n  Lightbulb, MessageSquare, AlertTriangle, Mic, CalendarPlus,\n  Mail, BookOpen, Clock, Eye\n} from \"lucide-react\";\nimport { supabase } from \"../../lib\";\n\ninterface ContactRequest {\n  id: string;\n  user_id: string | null;\n  reason: string;\n  message: string;\n  status: string;\n  created_at: string;\n  user_name?: string;\n  user_photo?: string | null;\n}\n\nconst TYPE_FILTERS = [\n  { key: 'all', label: 'Todos', icon: Inbox },\n  { key: 'tema_live', label: 'Temas Live', icon: Lightbulb },\n  { key: 'contato', label: 'Contato', icon: Mail },\n  { key: 'historia', label: 'Historias', icon: BookOpen },\n  { key: 'evento', label: 'Eventos', icon: CalendarPlus },\n  { key: 'live_application', label: 'Quero fazer Live', icon: Mic },\n  { key: 'denuncia', label: 'Denuncias', icon: AlertTriangle },\n  { key: 'feedback', label: 'Feedback', icon: MessageSquare },\n];\n\nfunction detectType(message: string): string {\n  const upper = message.toUpperCase();\n  if (upper.startsWith('[TEMA_LIVE]')) return 'tema_live';\n  if (upper.startsWith('[CONTATO]')) return 'contato';\n  if (upper.startsWith('[HISTORIA]')) return 'historia';\n  if (upper.startsWith('[EVENTO_SUGESTAO]') || upper.startsWith('[EVENTO]')) return 'evento';\n  if (upper.startsWith('[LIVE_APPLICATION]')) return 'live_application';\n  if (upper.startsWith('[DENUNCIA]')) return 'denuncia';\n  return 'feedback';\n}\n\nfunction getTypeConfig(type: string) {\n  const configs: Record<string, { label: string; icon: typeof Inbox; color: string }> = {\n    tema_live: { label: 'Tema Live', icon: Lightbulb, color: '#C8102E' },\n    contato: { label: 'Contato', icon: Mail, color: '#81D8D0' },\n    historia: { label: 'Historia', icon: BookOpen, color: '#FF6B35' },\n    evento: { label: 'Evento', icon: CalendarPlus, color: '#FF6B35' },\n    live_application: { label: 'Quer fazer Live', icon: Mic, color: '#C8102E' },\n    denuncia: { label: 'Denuncia', icon: AlertTriangle, color: '#C8102E' },\n    feedback: { label: 'Feedback', icon: MessageSquare, color: '#81D8D0' },\n  };\n  return configs[type] || configs.feedback;\n}\n\nexport function InboxPanel() {\n  const [requests, setRequests] = useState<ContactRequest[]>([]);\n  const [isLoading, setIsLoading] = useState(true);\n  const [typeFilter, setTypeFilter] = useState('all');\n  const [statusFilter, setStatusFilter] = useState<'all' | 'pending' | 'resolved'>('pending');\n  const [searchTerm, setSearchTerm] = useState('');\n  const [expandedId, setExpandedId] = useState<string | null>(null);\n\n  const loadRequests = useCallback(async () => {\n    setIsLoading(true);\n    try {\n      let query = supabase\n        .from('contact_requests')\n        .select('*')\n        .order('created_at', { ascending: false })\n        .limit(200);\n\n      if (statusFilter !== 'all') {\n        query = query.eq('status', statusFilter);\n      }\n\n      const { data, error } = await query;\n      if (error) throw error;\n\n      const items = (data || []) as ContactRequest[];\n\n      // Enrich with user names\n      const userIds = [...new Set(items.filter(r => r.user_id).map(r => r.user_id!))];\n      let usersMap: Record<string, { name: string; display_name?: string; photo: string | null }> = {};\n      if (userIds.length > 0) {\n        const { data: usersData } = await supabase\n          .from('users')\n          .select('id, name, display_name, profile_photo')\n          .in('id', userIds);\n        (usersData || []).forEach((u: any) => {\n          usersMap[u.id] = { name: u.name, display_name: u.display_name, photo: u.profile_photo };\n        });\n      }\n\n      setRequests(items.map(r => ({\n        ...r,\n        user_name: r.user_id ? (usersMap[r.user_id]?.display_name || usersMap[r.user_id]?.name || 'Desconhecido') : 'Anonimo',\n        user_photo: r.user_id ? usersMap[r.user_id]?.photo || null : null,\n      })));\n    } catch (err) {\n      console.error('[InboxPanel] Erro ao carregar:', err);\n    } finally {\n      setIsLoading(false);\n    }\n  }, [statusFilter]);\n\n  useEffect(() => { loadRequests(); }, [loadRequests]);\n\n  const markAsResolved = async (id: string) => {\n    try {\n      await supabase\n        .from('contact_requests')\n        .update({ status: 'resolved' })\n        .eq('id', id);\n      await loadRequests();\n    } catch (err) {\n      console.error('[InboxPanel] Erro ao resolver:', err);\n    }\n  };\n\n  const markAsPending = async (id: string) => {\n    try {\n      await supabase\n        .from('contact_requests')\n        .update({ status: 'pending' })\n        .eq('id', id);\n      await loadRequests();\n    } catch (err) {\n      console.error('[InboxPanel] Erro ao reabrir:', err);\n    }\n  };\n\n  // Filter by type and search\n  const filtered = requests.filter(r => {\n    const type = detectType(r.message);\n    if (typeFilter !== 'all' && type !== typeFilter) return false;\n    if (searchTerm) {\n      const s = searchTerm.toLowerCase();\n      return r.message.toLowerCase().includes(s) ||\n             (r.user_name || '').toLowerCase().includes(s);\n    }\n    return true;\n  });\n\n  // Count by type\n  const typeCounts: Record<string, number> = {};\n  requests.forEach(r => {\n    const type = detectType(r.message);\n    typeCounts[type] = (typeCounts[type] || 0) + 1;\n  });\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"flex flex-wrap items-center justify-between gap-3\">\n        <h2 className=\"text-white font-bold flex items-center gap-2\">\n          <Inbox className=\"w-5 h-5 text-[#81D8D0]\" /> Caixa de Entrada ({requests.length})\n        </h2>\n        <button onClick={loadRequests} className=\"p-2 bg-white/5 border border-white/10 rounded-lg hover:bg-white/10 transition-colors\">\n          <RefreshCw className=\"w-4 h-4 text-white/60\" />\n        </button>\n      </div>\n\n      {/* Status filter */}\n      <div className=\"flex gap-2\">\n        {(['pending', 'resolved', 'all'] as const).map(s => (\n          <button\n            key={s}\n            onClick={() => setStatusFilter(s)}\n            className={`px-3 py-1.5 rounded-lg text-xs font-semibold border transition-colors ${\n              statusFilter === s\n                ? 'bg-[#81D8D0]/15 text-[#81D8D0] border-[#81D8D0]/30'\n                : 'bg-white/5 text-white/40 border-white/10 hover:border-white/20'\n            }`}\n          >\n            {{ pending: 'Pendentes', resolved: 'Resolvidos', all: 'Todos' }[s]}\n            {s === 'pending' && requests.filter(r => r.status === 'pending').length > 0 && (\n              <span className=\"ml-1.5 px-1.5 py-0.5 bg-[#C8102E] text-white rounded-full text-[9px] font-bold\">\n                {requests.filter(r => r.status === 'pending').length}\n              </span>\n            )}\n          </button>\n        ))}\n      </div>\n\n      {/* Type filters */}\n      <div className=\"flex flex-wrap gap-2\">\n        {TYPE_FILTERS.map(f => {\n          const count = f.key === 'all' ? requests.length : (typeCounts[f.key] || 0);\n          if (f.key !== 'all' && count === 0) return null;\n          return (\n            <button\n              key={f.key}\n              onClick={() => setTypeFilter(f.key)}\n              className={`flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-xs font-medium border transition-colors ${\n                typeFilter === f.key\n                  ? 'bg-white/10 text-white border-white/20'\n                  : 'bg-white/5 text-white/40 border-white/10 hover:border-white/15'\n              }`}\n            >\n              <f.icon className=\"w-3 h-3\" />\n              {f.label}\n              {count > 0 && <span className=\"text-white/30\">({count})</span>}\n            </button>\n          );\n        })}\n      </div>\n\n      {/* Search */}\n      <div className=\"relative\">\n        <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-white/30\" />\n        <input\n          value={searchTerm}\n          onChange={(e) => setSearchTerm(e.target.value)}\n          placeholder=\"Buscar por mensagem ou nome...\"\n          className=\"w-full bg-white/5 border border-white/10 rounded-xl pl-10 pr-4 py-2.5 text-white placeholder:text-white/30 focus:outline-none focus:border-[#81D8D0]/50 text-sm\"\n        />\n      </div>\n\n      {/* List */}\n      {isLoading ? (\n        <div className=\"flex justify-center py-12\">\n          <div className=\"w-8 h-8 border-2 border-[#81D8D0] border-t-transparent rounded-full animate-spin\" />\n        </div>\n      ) : filtered.length === 0 ? (\n        <div className=\"text-center py-12 bg-white/5 rounded-2xl border border-white/10\">\n          <Inbox className=\"w-10 h-10 mx-auto mb-3 text-white opacity-30\" />\n          <p className=\"text-white/60 text-sm\">\n            {requests.length === 0 ? 'Nenhuma solicitacao recebida ainda.' : 'Nenhuma solicitacao neste filtro.'}\n          </p>\n        </div>\n      ) : (\n        <div className=\"space-y-2\">\n          {filtered.map((r) => {\n            const type = detectType(r.message);\n            const config = getTypeConfig(type);\n            const TypeIcon = config.icon;\n            const isExpanded = expandedId === r.id;\n            const isPending = r.status === 'pending';\n\n            // Clean message: remove prefix tag\n            const cleanMsg = r.message.replace(/^\\[.*?\\]\\s*\\|?\\s*/, '').trim();\n\n            return (\n              <div\n                key={r.id}\n                className={`bg-white/5 border rounded-xl transition-all ${\n                  isPending ? 'border-white/15' : 'border-white/5 opacity-60'\n                }`}\n              >\n                <div\n                  className=\"flex items-start gap-3 p-4 cursor-pointer\"\n                  onClick={() => setExpandedId(isExpanded ? null : r.id)}\n                >\n                  <div\n                    className=\"w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0\"\n                    style={{ backgroundColor: `${config.color}20`, border: `1px solid ${config.color}30` }}\n                  >\n                    <TypeIcon className=\"w-4 h-4\" style={{ color: config.color }} />\n                  </div>\n\n                  <div className=\"flex-1 min-w-0\">\n                    <div className=\"flex items-center gap-2 mb-1 flex-wrap\">\n                      <span\n                        className=\"text-[10px] px-2 py-0.5 rounded-full font-bold\"\n                        style={{ backgroundColor: `${config.color}20`, color: config.color }}\n                      >\n                        {config.label}\n                      </span>\n                      <span className={`text-[10px] px-2 py-0.5 rounded-full font-medium ${\n                        isPending ? 'bg-amber-500/20 text-amber-400' : 'bg-green-500/20 text-green-400'\n                      }`}>\n                        {isPending ? 'PENDENTE' : 'RESOLVIDO'}\n                      </span>\n                      <span className=\"text-white/60 text-xs font-medium\">{r.user_name}</span>\n                    </div>\n                    <p className=\"text-white/70 text-sm line-clamp-2\">{cleanMsg}</p>\n                    <div className=\"flex items-center gap-2 mt-1 text-xs text-white/30\">\n                      <Clock className=\"w-3 h-3\" />\n                      {new Date(r.created_at).toLocaleDateString('pt-BR', {\n                        day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit'\n                      })}\n                    </div>\n                  </div>\n\n                  <Eye className={`w-4 h-4 flex-shrink-0 transition-transform ${isExpanded ? 'text-[#81D8D0] rotate-0' : 'text-white/20 -rotate-90'}`} />\n                </div>\n\n                {/* Expanded content */}\n                {isExpanded && (\n                  <div className=\"px-4 pb-4 border-t border-white/5 pt-3\">\n                    <div className=\"bg-white/5 rounded-lg p-3 mb-3\">\n                      <p className=\"text-white/80 text-sm whitespace-pre-wrap leading-relaxed\">{cleanMsg}</p>\n                    </div>\n                    <div className=\"flex items-center gap-3 text-xs text-white/30 mb-3\">\n                      <span>ID: {r.id.slice(0, 8)}...</span>\n                      <span>Reason: {r.reason}</span>\n                      {r.user_id && <span>User: {r.user_id.slice(0, 8)}...</span>}\n                    </div>\n                    <div className=\"flex gap-2\">\n                      {isPending ? (\n                        <button\n                          onClick={(e) => { e.stopPropagation(); markAsResolved(r.id); }}\n                          className=\"flex items-center gap-1.5 px-4 py-2 bg-[#81D8D0] text-black rounded-lg text-xs font-bold hover:bg-[#81D8D0]/90 transition-colors\"\n                        >\n                          <CheckCircle className=\"w-3.5 h-3.5\" /> Marcar como resolvido\n                        </button>\n                      ) : (\n                        <button\n                          onClick={(e) => { e.stopPropagation(); markAsPending(r.id); }}\n                          className=\"flex items-center gap-1.5 px-4 py-2 bg-amber-500/20 text-amber-400 rounded-lg text-xs font-bold hover:bg-amber-500/30 transition-colors\"\n                        >\n                          <XCircle className=\"w-3.5 h-3.5\" /> Reabrir\n                        </button>\n                      )}\n                    </div>\n                  </div>\n                )}\n              </div>\n            );\n          })}\n        </div>\n      )}\n    </div>\n  );\n}"
}