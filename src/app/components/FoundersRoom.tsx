{
  "lote": 4,
  "status": "pending",
  "file_path": "src/app/components/FoundersRoom.tsx",
  "created_at": "2026-02-27T05:36:27.444Z",
  "file_content": "/**\n * FoundersRoom — Sala privada para founders e super_admin\n * \n * Chat em tempo real apenas para roles: founder_paid, moderator, super_admin.\n * Canal unico identificado como \"founders_room\" no sistema de chat.\n * Acesso pela sidebar do SocialHub.\n */\n\nimport { useState, useEffect, useRef, useCallback } from \"react\";\nimport { motion, AnimatePresence } from \"motion/react\";\nimport {\n  ArrowLeft, Crown, Send, Loader2, Users, Lock,\n  Sparkles, MessageCircle\n} from \"lucide-react\";\nimport { supabase } from \"../../lib/supabase\";\nimport { useProfileContext } from \"../../lib/ProfileContext\";\nimport { UserAvatar } from \"./UserAvatar\";\nimport { LogoIcon } from \"./LogoIcon\";\n\ninterface FoundersMessage {\n  id: string;\n  user_id: string;\n  content: string;\n  created_at: string;\n  user_name: string;\n  user_photo: string | null;\n  user_role: string;\n}\n\n// ID fixo da \"comunidade\" founders room (usamos um UUID determinístico)\nconst FOUNDERS_ROOM_ID = \"00000000-0000-0000-0000-f0und3r5r00m\";\n\ninterface FoundersRoomProps {\n  onBack: () => void;\n  onNavigateToProfile?: (userId: string) => void;\n}\n\nexport function FoundersRoom({ onBack, onNavigateToProfile }: FoundersRoomProps) {\n  const { user } = useProfileContext();\n  const [messages, setMessages] = useState<FoundersMessage[]>([]);\n  const [newMessage, setNewMessage] = useState(\"\");\n  const [sending, setSending] = useState(false);\n  const [isLoading, setIsLoading] = useState(true);\n  const [onlineCount, setOnlineCount] = useState(0);\n  const chatEndRef = useRef<HTMLDivElement>(null);\n  const inputRef = useRef<HTMLInputElement>(null);\n\n  // Mapa de users para evitar re-queries\n  const userCache = useRef<Record<string, { name: string; photo: string | null; role: string }>>({});\n\n  // Carregar usuario no cache\n  const loadUserInfo = useCallback(async (userId: string) => {\n    if (userCache.current[userId]) return userCache.current[userId];\n\n    const { data } = await supabase\n      .from(\"users\")\n      .select(\"name, display_name, profile_photo, role\")\n      .eq(\"id\", userId)\n      .single();\n\n    if (data) {\n      userCache.current[userId] = {\n        name: data.display_name || data.name,\n        photo: data.profile_photo,\n        role: data.role,\n      };\n      return userCache.current[userId];\n    }\n    return { name: \"Membro\", photo: null, role: \"member_free_legacy\" };\n  }, []);\n\n  // Carregar mensagens iniciais\n  useEffect(() => {\n    async function loadMessages() {\n      setIsLoading(true);\n      try {\n        // Buscar mensagens do chat com channel_id = FOUNDERS_ROOM_ID\n        const { data: msgs, error } = await supabase\n          .from(\"chat_messages\")\n          .select(\"id, user_id, content, created_at\")\n          .eq(\"community_id\", FOUNDERS_ROOM_ID)\n          .order(\"created_at\", { ascending: true })\n          .limit(100);\n\n        if (error) {\n          // Tabela pode nao ter o registro — nao e erro critico\n          console.log(\"[FoundersRoom] Nenhuma mensagem ainda ou erro:\", error.message);\n          setIsLoading(false);\n          return;\n        }\n\n        if (msgs && msgs.length > 0) {\n          const enriched: FoundersMessage[] = [];\n          for (const msg of msgs) {\n            const info = await loadUserInfo(msg.user_id);\n            enriched.push({\n              id: msg.id,\n              user_id: msg.user_id,\n              content: msg.content,\n              created_at: msg.created_at,\n              user_name: info.name,\n              user_photo: info.photo,\n              user_role: info.role,\n            });\n          }\n          setMessages(enriched);\n        }\n      } catch (err) {\n        console.error(\"[FoundersRoom] Erro ao carregar:\", err);\n      } finally {\n        setIsLoading(false);\n      }\n    }\n\n    loadMessages();\n  }, [loadUserInfo]);\n\n  // Realtime subscription\n  useEffect(() => {\n    const channel = supabase\n      .channel(`founders-room`)\n      .on(\n        \"postgres_changes\",\n        {\n          event: \"INSERT\",\n          schema: \"public\",\n          table: \"chat_messages\",\n          filter: `community_id=eq.${FOUNDERS_ROOM_ID}`,\n        },\n        async (payload) => {\n          const msg = payload.new as any;\n          const info = await loadUserInfo(msg.user_id);\n          setMessages(prev => [...prev, {\n            id: msg.id,\n            user_id: msg.user_id,\n            content: msg.content,\n            created_at: msg.created_at,\n            user_name: info.name,\n            user_photo: info.photo,\n            user_role: info.role,\n          }]);\n        }\n      )\n      .subscribe();\n\n    return () => { supabase.removeChannel(channel); };\n  }, [loadUserInfo]);\n\n  // Contar founders online (aproximado)\n  useEffect(() => {\n    async function countFounders() {\n      const { count } = await supabase\n        .from(\"users\")\n        .select(\"id\", { count: \"exact\", head: true })\n        .in(\"role\", [\"founder_paid\", \"moderator\", \"super_admin\"]);\n      setOnlineCount(count || 0);\n    }\n    countFounders();\n  }, []);\n\n  // Auto-scroll\n  useEffect(() => {\n    chatEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\n  }, [messages]);\n\n  // Enviar mensagem\n  const handleSend = async () => {\n    if (!newMessage.trim() || !user || sending) return;\n    setSending(true);\n\n    try {\n      const { error } = await supabase.from(\"chat_messages\").insert({\n        community_id: FOUNDERS_ROOM_ID,\n        user_id: user.id,\n        content: newMessage.trim(),\n      });\n\n      if (error) throw error;\n      setNewMessage(\"\");\n      inputRef.current?.focus();\n    } catch (err) {\n      console.error(\"[FoundersRoom] Erro ao enviar:\", err);\n    } finally {\n      setSending(false);\n    }\n  };\n\n  const handleKeyDown = (e: React.KeyboardEvent) => {\n    if (e.key === \"Enter\" && !e.shiftKey) {\n      e.preventDefault();\n      handleSend();\n    }\n  };\n\n  function getRoleBadge(role: string) {\n    switch (role) {\n      case \"super_admin\":\n        return { label: \"Admin\", color: \"#C8102E\" };\n      case \"moderator\":\n        return { label: \"Mod\", color: \"#81D8D0\" };\n      case \"founder_paid\":\n        return { label: \"Founder\", color: \"#FF6B35\" };\n      default:\n        return null;\n    }\n  }\n\n  function formatTime(dateStr: string) {\n    return new Date(dateStr).toLocaleTimeString(\"pt-BR\", { hour: \"2-digit\", minute: \"2-digit\" });\n  }\n\n  function formatDate(dateStr: string) {\n    const date = new Date(dateStr);\n    const today = new Date();\n    if (date.toDateString() === today.toDateString()) return \"Hoje\";\n    const yesterday = new Date(today);\n    yesterday.setDate(yesterday.getDate() - 1);\n    if (date.toDateString() === yesterday.toDateString()) return \"Ontem\";\n    return date.toLocaleDateString(\"pt-BR\", { day: \"numeric\", month: \"short\" });\n  }\n\n  // Agrupar mensagens por dia\n  let lastDate = \"\";\n\n  return (\n    <div className=\"min-h-screen bg-black flex flex-col\">\n      {/* Header */}\n      <div className=\"bg-[#35363A] border-b border-white/10 px-6 py-3 flex-shrink-0\">\n        <div className=\"mx-auto max-w-[800px] flex items-center justify-between\">\n          <button onClick={onBack} className=\"flex items-center gap-2 text-white/80 hover:text-[#81D8D0] transition-colors\">\n            <ArrowLeft className=\"h-5 w-5\" />\n            <span className=\"font-medium text-sm\">Voltar</span>\n          </button>\n          <div className=\"flex items-center gap-3\">\n            <div className=\"w-9 h-9 rounded-xl bg-[#FF6B35]/15 border border-[#FF6B35]/30 flex items-center justify-center\">\n              <Crown className=\"h-5 w-5 text-[#FF6B35]\" />\n            </div>\n            <div>\n              <h1 className=\"text-base text-white font-bold\">Sala dos Fundadores</h1>\n              <div className=\"flex items-center gap-2\">\n                <Lock className=\"h-2.5 w-2.5 text-white/30\" />\n                <span className=\"text-[10px] text-white/30\">Privada</span>\n                <span className=\"text-[10px] text-white/30\">|</span>\n                <Users className=\"h-2.5 w-2.5 text-[#FF6B35]\" />\n                <span className=\"text-[10px] text-[#FF6B35] font-semibold\">{onlineCount} fundadores</span>\n              </div>\n            </div>\n          </div>\n          <div className=\"w-20\" />\n        </div>\n      </div>\n\n      {/* Welcome banner */}\n      <div className=\"mx-auto max-w-[800px] w-full px-6 pt-4\">\n        <div className=\"bg-[#FF6B35]/8 border border-[#FF6B35]/15 rounded-xl p-4 mb-4\">\n          <div className=\"flex items-start gap-3\">\n            <Sparkles className=\"h-5 w-5 text-[#FF6B35] mt-0.5 flex-shrink-0\" />\n            <div>\n              <p className=\"text-xs text-[#FF6B35] font-bold mb-1\">Territorio exclusivo</p>\n              <p className=\"text-[11px] text-white/40 leading-relaxed\">\n                Aqui e onde fundadores, moderadores e a criadora se encontram. \n                Discuta estrategias, alinhe decisoes e fortaleca o territorio.\n              </p>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Messages area */}\n      <div className=\"flex-1 overflow-y-auto px-6\">\n        <div className=\"mx-auto max-w-[800px] py-4 space-y-1\">\n          {isLoading ? (\n            <div className=\"flex items-center justify-center py-12\">\n              <div className=\"w-8 h-8 border-3 border-[#FF6B35] border-t-transparent rounded-full animate-spin\" />\n            </div>\n          ) : messages.length === 0 ? (\n            <div className=\"text-center py-16\">\n              <MessageCircle className=\"h-12 w-12 text-white/10 mx-auto mb-3\" />\n              <p className=\"text-sm text-white/30 font-semibold\">Nenhuma mensagem ainda</p>\n              <p className=\"text-xs text-white/20 mt-1\">Comece a conversa entre fundadores!</p>\n            </div>\n          ) : (\n            messages.map((msg) => {\n              const msgDate = formatDate(msg.created_at);\n              const showDateSeparator = msgDate !== lastDate;\n              lastDate = msgDate;\n              const isMe = msg.user_id === user?.id;\n              const badge = getRoleBadge(msg.user_role);\n\n              return (\n                <div key={msg.id}>\n                  {showDateSeparator && (\n                    <div className=\"flex items-center gap-3 py-3\">\n                      <div className=\"flex-1 h-px bg-white/8\" />\n                      <span className=\"text-[10px] text-white/25 font-semibold\">{msgDate}</span>\n                      <div className=\"flex-1 h-px bg-white/8\" />\n                    </div>\n                  )}\n                  <motion.div\n                    initial={{ opacity: 0, y: 5 }}\n                    animate={{ opacity: 1, y: 0 }}\n                    className={`flex items-start gap-3 py-2 px-3 rounded-xl hover:bg-white/3 transition-colors ${\n                      isMe ? \"\" : \"\"\n                    }`}\n                  >\n                    <UserAvatar\n                      name={msg.user_name}\n                      photoUrl={msg.user_photo}\n                      size=\"sm\"\n                      onClick={() => onNavigateToProfile?.(msg.user_id)}\n                    />\n                    <div className=\"flex-1 min-w-0\">\n                      <div className=\"flex items-center gap-2\">\n                        <span\n                          className=\"text-xs font-bold cursor-pointer hover:text-[#81D8D0] transition-colors\"\n                          style={{ color: isMe ? \"#81D8D0\" : \"#fff\" }}\n                          onClick={() => onNavigateToProfile?.(msg.user_id)}\n                        >\n                          {msg.user_name}\n                        </span>\n                        {badge && (\n                          <span\n                            className=\"text-[9px] px-1.5 py-0.5 rounded-full font-bold\"\n                            style={{ background: `${badge.color}20`, color: badge.color }}\n                          >\n                            {badge.label}\n                          </span>\n                        )}\n                        <span className=\"text-[10px] text-white/20\">{formatTime(msg.created_at)}</span>\n                      </div>\n                      <p className=\"text-sm text-white/75 leading-relaxed mt-0.5 break-words\">\n                        {msg.content}\n                      </p>\n                    </div>\n                  </motion.div>\n                </div>\n              );\n            })\n          )}\n          <div ref={chatEndRef} />\n        </div>\n      </div>\n\n      {/* Input area */}\n      <div className=\"bg-[#1A1A1A] border-t border-white/10 px-6 py-4 flex-shrink-0\">\n        <div className=\"mx-auto max-w-[800px] flex items-center gap-3\">\n          <input\n            ref={inputRef}\n            type=\"text\"\n            value={newMessage}\n            onChange={(e) => setNewMessage(e.target.value)}\n            onKeyDown={handleKeyDown}\n            placeholder=\"Escreva para os fundadores...\"\n            className=\"flex-1 px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white text-sm placeholder:text-white/25 focus:border-[#FF6B35]/50 focus:outline-none\"\n          />\n          <button\n            onClick={handleSend}\n            disabled={!newMessage.trim() || sending}\n            className=\"px-4 py-3 bg-[#FF6B35] hover:bg-[#FF6B35]/90 disabled:opacity-40 disabled:cursor-not-allowed text-white rounded-xl transition-all\"\n          >\n            {sending ? (\n              <Loader2 className=\"h-5 w-5 animate-spin\" />\n            ) : (\n              <Send className=\"h-5 w-5\" />\n            )}\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n}"
}